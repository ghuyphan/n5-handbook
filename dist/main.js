import{A as O,B as T,C as F,D as U,E as R,a as o,b as A,c as m,d as a,e as D,f as C,g as b,h as g,i as I,j as L,k as B,l as x,m as M,n as P,o as j,p as w,q as y,r as q,s as z,t as N,u as E,v as V,w as $,x as H,y as K,z as S}from"./chunk-ABVIOLBK.js";var c;window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),c=t;let l=document.getElementById("install-app-btn");l&&(l.style.display="flex")});async function J(){if(c){c.prompt();let{outcome:t}=await c.userChoice;console.log(`User response to the install prompt: ${t}`),c=null;let l=document.getElementById("install-app-btn");l&&(l.style.display="none")}}window.addEventListener("appinstalled",()=>{let t=document.getElementById("install-app-btn");t&&(t.style.display="none"),c=null,console.log("PWA was installed")});var W=(t,l={})=>{let e=a.appData.ui?.[a.currentLang]?.[t]||a.appData.ui?.en?.[t]||`[${t}]`;t==="lastSavedOn"&&!a.appData.ui?.[a.currentLang]?.[t]&&(e="Last saved: {date}");for(let[n,s]of Object.entries(l))e=e.replace(`{${n}}`,s);return e};async function Q(){let t=["kanji","vocab"],l=[];for(let e of t)a.appData[e]||await(await S).get("levels",a.currentLevel)||l.push(F(a.currentLevel,e));if(l.length>0)try{await Promise.all(l)}catch(e){console.error("Failed to load required data for progress dashboard:",e)}}async function k(t,...l){await M(t,...l),t==="progress"&&w();let e=!["progress","external-search"].includes(t),n=document.querySelectorAll(".notes-header-btn");if(n.forEach(s=>{s.style.display=e?"flex":"none",s.classList.remove("has-note")}),e){let s=await R(a.currentLevel,t),r=s&&typeof s=="object"?!!s.content?.trim():!!s?.trim();n.forEach(i=>{i.classList.toggle("has-note",r)})}}function X(){return'<label class="theme-switch"><input type="checkbox" aria-label="Theme toggle"><span class="slider"></span></label>'}function G(){return'<div class="lang-switch-pill"></div><button data-lang="en">EN</button><button data-lang="vi">VI</button>'}function Y(t){t&&(t.level!==a.currentLevel?L(t.level,!0):k(t.tabName,null,!1,!0))}function Z(){let t=document.documentElement.classList.toggle("dark-mode"),l=t?"dark":"light";o.themeEmoji&&(o.themeEmoji.textContent=t?"\u{1F319}":"\u2600\uFE0F");let e=document.querySelector("#sidebar-controls .theme-switch input");e&&(e.checked=t),T("theme",l);try{localStorage.setItem("theme",l)}catch(n){console.warn("Could not save theme to localStorage.",n)}}function _(){document.body.addEventListener("click",e=>{let n=e.target.closest("[data-action]");if(!n)return;let s=n.dataset.action,r={"change-tab":()=>k(n.dataset.tabName,n),"toggle-sidebar":()=>{o.sidebar?.classList.add("open"),o.overlay?.classList.add("active"),document.body.classList.add("sidebar-open")},"toggle-theme":()=>Z(),"toggle-pin":()=>B(),"toggle-sidebar-pin":()=>x(e,n.dataset.tabName),"flip-card":()=>{e.target.closest('[data-action="show-kanji-details"]')||n.closest(".card").classList.toggle("is-flipped")},"toggle-learned":()=>C(n.dataset.category,n.dataset.id,n),"jump-to-section":()=>P(n.dataset.tabName,n.dataset.sectionKey),"delete-level":()=>j(n.dataset.levelName),"set-level":()=>L(n.dataset.levelName),"toggle-accordion":()=>{let i=a.activeTab,d=n.dataset.sectionTitleKey,u=n.classList.toggle("open");a.openAccordions.has(i)||a.openAccordions.set(i,new Set);let p=a.openAccordions.get(i);u?p.add(d):p.delete(d),a.levelSettings[a.currentLevel]||(a.levelSettings[a.currentLevel]={}),a.levelSettings[a.currentLevel].openAccordions=Array.from(a.openAccordions.entries()).map(([h,f])=>[h,Array.from(f)]),T("levelSettings",a.levelSettings)}};r[s]&&(e.preventDefault(),r[s]()),s==="open-notes"&&(e.preventDefault(),import("./modals-YSZ6CPLX.js").then(i=>i.openNotesModal())),s==="show-kanji-details"&&(e.preventDefault(),import("./modals-YSZ6CPLX.js").then(i=>i.openKanjiDetailModal(n.dataset.id))),s==="close-kanji-modal"&&(e.preventDefault(),import("./modals-YSZ6CPLX.js").then(i=>i.closeKanjiDetailModal()))}),o.overlay?.addEventListener("click",E),o.searchInput?.addEventListener("input",b),o.mobileSearchInput?.addEventListener("input",b),o.closeSidebarBtn?.addEventListener("click",E);let t=D(()=>{document.querySelectorAll(".lang-switch").forEach(y);let e=window.innerWidth<=768;if(o.pinToggle&&(o.pinToggle.style.display=e?"block":"none",e)){let n=document.querySelector(".tab-content.active");n&&z(n.id)}},100);window.addEventListener("resize",t),document.addEventListener("keydown",e=>{e.key==="Escape"&&(o.kanjiDetailModal.classList.contains("modal-hidden")?o.notesModal.classList.contains("modal-hidden"):import("./modals-YSZ6CPLX.js").then(n=>n.closeKanjiDetailModal()))}),window.addEventListener("popstate",e=>{Y(e.state)});let l=document.getElementById("install-app-btn");l&&l.addEventListener("click",J)}function ee(){o.sidebarControls&&(o.sidebarControls.innerHTML=`
            <div class="sidebar-control-group"><label class="sidebar-control-label" data-lang-key="level">Level</label><div id="level-switcher-sidebar" class="level-switch"></div></div>
            <div class="sidebar-control-group md:hidden"><label class="sidebar-control-label" data-lang-key="language">Language</label><div id="sidebar-lang-switcher" class="lang-switch">${G()}</div></div>
            <div class="sidebar-control-group md:hidden"><label class="sidebar-control-label" data-lang-key="theme">Theme</label><div class="theme-switch-wrapper">${X()}</div></div>
            <button id="install-app-btn" class="w-full mt-4 flex items-center justify-center gap-2 text-sm font-semibold p-3 rounded-lg transition-colors import-button" style="display: none;">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1h4a1 1 0 001-1V2zm-1 5a1 1 0 011 1v10a1 1 0 11-2 0V8a1 1 0 011-1zm-4-4h2V2H5v2zM15 4h-2V2h2v2zm-2 4h-2v10h2V8z"/></svg>
                <span class="pointer-events-none">Install App</span>
            </button>
            <button id="sidebar-import-btn" class="w-full mt-4 flex items-center justify-center gap-2 text-sm font-semibold p-3 rounded-lg transition-colors import-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span data-lang-key="importLevel" class="pointer-events-none">Import New Level</span></button>`);let t=document.getElementById("header-lang-switcher");t&&(t.innerHTML=G()),document.querySelectorAll(".sidebar-control-group .theme-switch input").forEach(l=>l.addEventListener("change",I)),document.querySelectorAll(".lang-switch button").forEach(l=>l.addEventListener("click",e=>{e.preventDefault(),g(e.currentTarget.dataset.lang)}))}async function te(){A(),await O(),ee(),_(),q(),document.getElementById("sidebar-import-btn")&&import("./modals-YSZ6CPLX.js").then(e=>e.setupImportModal()),o.loadingOverlay&&(o.loadingOverlay.style.opacity="0",o.loadingOverlay.addEventListener("transitionend",()=>o.loadingOverlay.classList.add("hidden"),{once:!0})),g(a.currentLang,!0),document.querySelectorAll(".lang-switch").forEach(y);let t=new URLSearchParams(window.location.search),l=t.get("tab")||a.pinnedTab||(window.innerWidth<=768,"external-search");try{let e=await S,n=fetch(`${m.dataPath}/levels.json`).then(v=>v.ok?v.json():{levels:[]}).catch(v=>(console.warn("Could not fetch remote levels list. Falling back to default.",v),{levels:[m.defaultLevel]})),s=e.getAllKeys("levels"),[r,i]=await Promise.all([n,s]),d=r.levels||[m.defaultLevel];a.allAvailableLevels=[...new Set([...d,...i])];let u=t.get("level");u&&a.allAvailableLevels.includes(u)&&(a.currentLevel=u),await U(a.currentLevel),$(d,i),document.querySelector(`.level-switch-button[data-level-name="${a.currentLevel}"]`)?.classList.add("active"),H(),await V(a.currentLevel),await Q(),w(),g(a.currentLang,!0),N(),await k(l,null,!1,!0);let p=document.getElementById("app-version");p&&(p.textContent="v1.0.0");let h={type:"tab",tabName:l,level:a.currentLevel},f=`?level=${a.currentLevel}&tab=${l}`;history.replaceState(h,"",f)}catch(e){console.error("Initialization failed.",e),o.loadingOverlay&&K(W("applicationErrorTitle","Application Error"),W("applicationErrorBody","Something went wrong during startup. Please try refreshing the page.")+`

Error: ${e.message}`)}}document.addEventListener("DOMContentLoaded",te);
