var c={};function xt(){c.sidebar=document.getElementById("sidebar"),c.overlay=document.getElementById("overlay"),c.mainContent=document.getElementById("main-content"),c.loadingOverlay=document.getElementById("loading-overlay"),c.levelBadgeDesktop=document.getElementById("level-badge-desktop"),c.levelBadgeMobile=document.getElementById("level-badge-mobile"),c.mobileHeaderTitle=document.getElementById("mobile-header-title"),c.searchInput=document.getElementById("search-input"),c.mobileSearchInput=document.getElementById("mobile-search-input"),c.mobileSearchBar=document.querySelector(".mobile-search-bar"),c.menuToggle=document.getElementById("menu-toggle"),c.pinToggle=document.getElementById("pin-toggle"),c.themeEmoji=document.getElementById("theme-emoji"),c.progressOverview=document.getElementById("progress-overview"),c.progressTab=document.getElementById("progress"),c.hiraganaTab=document.getElementById("hiragana"),c.katakanaTab=document.getElementById("katakana"),c.kanjiTab=document.getElementById("kanji"),c.keyPointsTab=document.getElementById("keyPoints"),c.vocabTab=document.getElementById("vocab"),c.grammarContainer=document.getElementById("grammar-container"),c.grammarTab=document.getElementById("grammar"),c.externalSearchTab=document.getElementById("external-search"),c.sidebarControls=document.getElementById("sidebar-controls"),c.closeSidebarBtn=document.getElementById("close-sidebar-btn"),c.importModal=document.getElementById("import-modal"),c.importModalBackdrop=document.getElementById("import-modal-backdrop"),c.modalWrapper=document.querySelector("#import-modal .modal-wrapper"),c.openModalBtn=document.getElementById("sidebar-import-btn"),c.closeModalBtn=document.getElementById("close-modal-btn"),c.levelNameInput=document.getElementById("level-name-input"),c.levelNameError=document.getElementById("level-name-error"),c.fileImportArea=document.getElementById("file-import-area"),c.fileInput=document.getElementById("file-input"),c.importBtn=document.getElementById("import-btn"),c.desktopNotesBtn=document.getElementById("desktop-notes-btn"),c.mobileNotesBtn=document.getElementById("mobile-notes-btn"),c.notesModal=document.getElementById("notes-modal"),c.notesModalBackdrop=document.getElementById("notes-modal-backdrop"),c.notesModalWrapper=document.querySelector("#notes-modal .modal-wrapper"),c.notesModalTitle=document.getElementById("notes-modal-title"),c.closeNotesModalBtn=document.getElementById("close-notes-modal-btn"),c.notesTextarea=document.getElementById("notes-textarea"),c.notesSaveBtn=document.getElementById("notes-save-btn"),c.notesStatus=document.getElementById("notes-status"),c.kanjiDetailModal=document.getElementById("kanji-detail-modal"),c.kanjiModalBackdrop=document.querySelector("#kanji-detail-modal #modal-backdrop"),c.kanjiModalContentContainer=document.querySelector("#kanji-detail-modal #modal-content-container"),c.customDialogContainer=document.getElementById("custom-dialog-container"),c.customDialogBackdrop=document.getElementById("custom-dialog-backdrop"),c.customDialogWrapper=document.querySelector("#custom-dialog-container .modal-wrapper")}var I={defaultLevel:"n5",dataPath:"https://raw.githubusercontent.com/ghuyphan/JLPT_Datas/main"},d={appData:{},progress:{kanji:[],vocab:[]},currentLang:"en",currentLevel:I.defaultLevel,allAvailableLevels:[I.defaultLevel],pinnedTab:null,isSwitchingLevel:!1,loadingStatus:"idle",activeTab:"progress",notes:{data:new Map,originalContent:""},fuseInstances:{},universalFuse:null,currentQuery:"",lastDictionaryQuery:"",tabScrollPositions:new Map,renderedTabs:new Map,externalDB:{vocab:[],kanji:[],vocabFuse:null,kanjiFuse:null}};var Pe=(e,t)=>t.some(n=>e instanceof n),Tt,St;function Fn(){return Tt||(Tt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Kn(){return St||(St=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var Fe=new WeakMap,_e=new WeakMap,ye=new WeakMap;function Hn(e){let t=new Promise((n,a)=>{let r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{n(V(e.result)),r()},s=()=>{a(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",s)});return ye.set(t,e),t}function Un(e){if(Fe.has(e))return;let t=new Promise((n,a)=>{let r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{n(),r()},s=()=>{a(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)});Fe.set(e,t)}var Ke={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return Fe.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return V(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function It(e){Ke=e(Ke)}function qn(e){return Kn().includes(e)?function(...t){return e.apply(He(this),t),V(this.request)}:function(...t){return V(e.apply(He(this),t))}}function Wn(e){return typeof e=="function"?qn(e):(e instanceof IDBTransaction&&Un(e),Pe(e,Fn())?new Proxy(e,Ke):e)}function V(e){if(e instanceof IDBRequest)return Hn(e);if(_e.has(e))return _e.get(e);let t=Wn(e);return t!==e&&(_e.set(e,t),ye.set(t,e)),t}var He=e=>ye.get(e);function Bt(e,t,{blocked:n,upgrade:a,blocking:r,terminated:o}={}){let s=indexedDB.open(e,t),i=V(s);return a&&s.addEventListener("upgradeneeded",l=>{a(V(s.result),l.oldVersion,l.newVersion,V(s.transaction),l)}),n&&s.addEventListener("blocked",l=>n(l.oldVersion,l.newVersion,l)),i.then(l=>{o&&l.addEventListener("close",()=>o()),r&&l.addEventListener("versionchange",p=>r(p.oldVersion,p.newVersion,p))}).catch(()=>{}),i}var Jn=["get","getKey","getAll","getAllKeys","count"],zn=["put","add","delete","clear"],Re=new Map;function kt(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(Re.get(t))return Re.get(t);let n=t.replace(/FromIndex$/,""),a=t!==n,r=zn.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!(r||Jn.includes(n)))return;let o=async function(s,...i){let l=this.transaction(s,r?"readwrite":"readonly"),p=l.store;return a&&(p=p.index(i.shift())),(await Promise.all([p[n](...i),r&&l.done]))[0]};return Re.set(t,o),o}It(e=>({...e,get:(t,n,a)=>kt(t,n)||e.get(t,n,a),has:(t,n)=>!!kt(t,n)||e.has(t,n)}));var Vn=["continue","continuePrimaryKey","advance"],Dt={},Ue=new WeakMap,jt=new WeakMap,Gn={get(e,t){if(!Vn.includes(t))return e[t];let n=Dt[t];return n||(n=Dt[t]=function(...a){Ue.set(this,jt.get(this)[t](...a))}),n}};async function*Yn(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,Gn);for(jt.set(n,t),ye.set(n,He(t));t;)yield n,t=await(Ue.get(n)||t.continue()),Ue.delete(n)}function Mt(e,t){return t===Symbol.asyncIterator&&Pe(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&Pe(e,[IDBIndex,IDBObjectStore])}It(e=>({...e,get(t,n,a){return Mt(t,n)?Yn:e.get(t,n,a)},has(t,n){return Mt(t,n)||e.has(t,n)}}));function te(e){return e===null?"null":e!==Object(e)?typeof e:{}.toString.call(e).slice(8,-1).toLowerCase()}function N(e){return te(e)!=="string"?!0:!e.length}function ne(e="",t,n){if(N(e))return!1;let a=e.charCodeAt(0);return t<=a&&a<=n}var Nt={HIRAGANA:"toHiragana",KATAKANA:"toKatakana"},Kt={HEPBURN:"hepburn"},Zn={useObsoleteKana:!1,passRomaji:!1,convertLongVowelMark:!0,upcaseKatakana:!1,IMEMode:!1,romanization:Kt.HEPBURN},Qn=65,Xn=90,ea=65345,ta=65370,na=65313,aa=65338,Ve=12353,ra=12438,Ge=12449,oa=12540,sa=19968,ia=40879,ca=12293,la=12540,ua=12539,da=[65296,65305],pa=[na,aa],ma=[ea,ta],fa=[65281,65295],ha=[65306,65311],ga=[65339,65343],va=[65371,65376],ya=[65504,65518],ba=[12352,12447],Ea=[12448,12543],wa=[65382,65439],La=[12539,12540],Ht=[65377,65381],Aa=[12288,12351],Ca=[19968,40959],xa=[13312,19903],Ta=[ba,Ea,Ht,wa],Sa=[Aa,Ht,La,fa,ha,ga,va,ya],Oo=[...Ta,...Sa,pa,ma,da,Ca,xa],ka=[0,127],Da=[[256,257],[274,275],[298,299],[332,333],[362,363]],Ma=[[8216,8217],[8220,8221]],Ia=[ka,...Da],Ba=[[32,47],[58,63],[91,96],[123,126],...Ma];var Ot=Number.isNaN||function(t){return typeof t=="number"&&t!==t};function ja(e,t){return!!(e===t||Ot(e)&&Ot(t))}function Na(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!ja(e[n],t[n]))return!1;return!0}function Ut(e,t){t===void 0&&(t=Na);var n=null;function a(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];if(n&&n.lastThis===this&&t(r,n.lastArgs))return n.lastResult;var s=e.apply(this,r);return n={lastResult:s,lastArgs:r,lastThis:this},s}return a.clear=function(){n=null},a}var $t=Object.prototype.hasOwnProperty;function _t(e,t,n){for(n of e.keys())if(X(n,t))return n}function X(e,t){var n,a,r;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((a=e.length)===t.length)for(;a--&&X(e[a],t[a]););return a===-1}if(n===Set){if(e.size!==t.size)return!1;for(a of e)if(r=a,r&&typeof r=="object"&&(r=_t(t,r),!r)||!t.has(r))return!1;return!0}if(n===Map){if(e.size!==t.size)return!1;for(a of e)if(r=a[0],r&&typeof r=="object"&&(r=_t(t,r),!r)||!X(a[1],t.get(r)))return!1;return!0}if(n===ArrayBuffer)e=new Uint8Array(e),t=new Uint8Array(t);else if(n===DataView){if((a=e.byteLength)===t.byteLength)for(;a--&&e.getInt8(a)===t.getInt8(a););return a===-1}if(ArrayBuffer.isView(e)){if((a=e.byteLength)===t.byteLength)for(;a--&&e[a]===t[a];);return a===-1}if(!n||typeof e=="object"){a=0;for(n in e)if($t.call(e,n)&&++a&&!$t.call(t,n)||!(n in t)||!X(e[n],t[n]))return!1;return Object.keys(t).length===a}}return e!==e&&t!==t}var Le=(e={})=>Object.assign({},Zn,e);function qt(e,t,n){let a=t;function r(i,l){if(i[l]!==void 0)return Object.assign({"":i[""]+l},i[l])}function o(i,l){let p=i.charAt(0);return s(Object.assign({"":p},a[p]),i.slice(1),l,l+1)}function s(i,l,p,m){if(!l)return n||Object.keys(i).length===1?i[""]?[[p,m,i[""]]]:[]:[[p,m,null]];if(Object.keys(i).length===1)return[[p,m,i[""]]].concat(o(l,m));let f=r(i,l.charAt(0));return f===void 0?[[p,m,i[""]]].concat(o(l,m)):s(f,l.slice(1),p,m+1)}return o(e,0)}function Ye(e){return Object.entries(e).reduce((t,[n,a])=>{let r=te(a)==="string";return t[n]=r?{"":a}:Ye(a),t},{})}function Wt(e,t){return t.split("").reduce((n,a)=>(n[a]===void 0&&(n[a]={}),n[a]),e)}function Jt(e={}){let t={};return te(e)==="object"&&Object.entries(e).forEach(([n,a])=>{let r=t;n.split("").forEach(o=>{r[o]===void 0&&(r[o]={}),r=r[o]}),r[""]=a}),function(a){let r=JSON.parse(JSON.stringify(a));function o(s,i){return s===void 0||te(s)==="string"?i:Object.entries(i).reduce((l,[p,m])=>(l[p]=o(s[p],m),l),s)}return o(r,t)}}function zt(e,t){return t?te(t)==="function"?t(e):Jt(t)(e):e}var Oa={a:"\u3042",i:"\u3044",u:"\u3046",e:"\u3048",o:"\u304A",k:{a:"\u304B",i:"\u304D",u:"\u304F",e:"\u3051",o:"\u3053"},s:{a:"\u3055",i:"\u3057",u:"\u3059",e:"\u305B",o:"\u305D"},t:{a:"\u305F",i:"\u3061",u:"\u3064",e:"\u3066",o:"\u3068"},n:{a:"\u306A",i:"\u306B",u:"\u306C",e:"\u306D",o:"\u306E"},h:{a:"\u306F",i:"\u3072",u:"\u3075",e:"\u3078",o:"\u307B"},m:{a:"\u307E",i:"\u307F",u:"\u3080",e:"\u3081",o:"\u3082"},y:{a:"\u3084",u:"\u3086",o:"\u3088"},r:{a:"\u3089",i:"\u308A",u:"\u308B",e:"\u308C",o:"\u308D"},w:{a:"\u308F",i:"\u3090",e:"\u3091",o:"\u3092"},g:{a:"\u304C",i:"\u304E",u:"\u3050",e:"\u3052",o:"\u3054"},z:{a:"\u3056",i:"\u3058",u:"\u305A",e:"\u305C",o:"\u305E"},d:{a:"\u3060",i:"\u3062",u:"\u3065",e:"\u3067",o:"\u3069"},b:{a:"\u3070",i:"\u3073",u:"\u3076",e:"\u3079",o:"\u307C"},p:{a:"\u3071",i:"\u3074",u:"\u3077",e:"\u307A",o:"\u307D"},v:{a:"\u3094\u3041",i:"\u3094\u3043",u:"\u3094",e:"\u3094\u3047",o:"\u3094\u3049"}},$a={".":"\u3002",",":"\u3001",":":"\uFF1A","/":"\u30FB","!":"\uFF01","?":"\uFF1F","~":"\u301C","-":"\u30FC","\u2018":"\u300C","\u2019":"\u300D","\u201C":"\u300E","\u201D":"\u300F","[":"\uFF3B","]":"\uFF3D","(":"\uFF08",")":"\uFF09","{":"\uFF5B","}":"\uFF5D"},Rt={k:"\u304D",s:"\u3057",t:"\u3061",n:"\u306B",h:"\u3072",m:"\u307F",r:"\u308A",g:"\u304E",z:"\u3058",d:"\u3062",b:"\u3073",p:"\u3074",v:"\u3094",q:"\u304F",f:"\u3075"},Vt={ya:"\u3083",yi:"\u3043",yu:"\u3085",ye:"\u3047",yo:"\u3087"},Gt={a:"\u3041",i:"\u3043",u:"\u3045",e:"\u3047",o:"\u3049"},Pt={sh:"sy",ch:"ty",cy:"ty",chy:"ty",shy:"sy",j:"zy",jy:"zy",shi:"si",chi:"ti",tsu:"tu",ji:"zi",fu:"hu"},_a=Object.assign({tu:"\u3063",wa:"\u308E",ka:"\u30F5",ke:"\u30F6"},Gt,Vt),Ra={yi:"\u3044",wu:"\u3046",ye:"\u3044\u3047",wi:"\u3046\u3043",we:"\u3046\u3047",kwa:"\u304F\u3041",whu:"\u3046",tha:"\u3066\u3083",thu:"\u3066\u3085",tho:"\u3066\u3087",dha:"\u3067\u3083",dhu:"\u3067\u3085",dho:"\u3067\u3087"},Pa={wh:"\u3046",kw:"\u304F",qw:"\u304F",q:"\u304F",gw:"\u3050",sw:"\u3059",ts:"\u3064",th:"\u3066",tw:"\u3068",dh:"\u3067",dw:"\u3069",fw:"\u3075",f:"\u3075"};function Fa(){let e=Ye(Oa),t=r=>Wt(e,r);Object.entries(Rt).forEach(([r,o])=>{Object.entries(Vt).forEach(([s,i])=>{t(r+s)[""]=o+i})}),Object.entries($a).forEach(([r,o])=>{t(r)[""]=o}),Object.entries(Pa).forEach(([r,o])=>{Object.entries(Gt).forEach(([s,i])=>{let l=t(r+s);l[""]=o+i})}),["n","n'","xn"].forEach(r=>{t(r)[""]="\u3093"}),e.c=JSON.parse(JSON.stringify(e.k)),Object.entries(Pt).forEach(([r,o])=>{let s=r.slice(0,r.length-1),i=r.charAt(r.length-1),l=t(s);l[i]=JSON.parse(JSON.stringify(t(o)))});function n(r){return[...Object.entries(Pt),["c","k"]].reduce((o,[s,i])=>r.startsWith(i)?o.concat(r.replace(i,s)):o,[])}Object.entries(_a).forEach(([r,o])=>{let s=f=>f.charAt(f.length-1),i=f=>f.slice(0,f.length-1),l=`x${r}`,p=t(l);p[""]=o;let m=t(`l${i(r)}`);m[s(r)]=p,n(r).forEach(f=>{["l","x"].forEach(h=>{let g=t(h+i(f));g[s(f)]=t(h+r)})})}),Object.entries(Ra).forEach(([r,o])=>{t(r)[""]=o});function a(r){return Object.entries(r).reduce((o,[s,i])=>(s?o[s]=a(i):o[s]=`\u3063${i}`,o),{})}return[...Object.keys(Rt),"c","y","w","j"].forEach(r=>{let o=e[r];o[r]=a(o)}),delete e.n.n,Object.freeze(JSON.parse(JSON.stringify(e)))}var qe=null;function Ka(){return qe==null&&(qe=Fa()),qe}var Ha=Jt({wi:"\u3090",we:"\u3091"});function Ua(e){let t=JSON.parse(JSON.stringify(e));return t.n.n={"":"\u3093"},t.n[" "]={"":"\u3093"},t}function qa(e=""){return N(e)?!1:ne(e,Qn,Xn)}function oe(e=""){return N(e)?!1:e.charCodeAt(0)===la}function Yt(e=""){return N(e)?!1:e.charCodeAt(0)===ua}function Ze(e=""){return N(e)?!1:oe(e)?!0:ne(e,Ve,ra)}function be(e=""){let t=[];return e.split("").forEach(n=>{if(oe(n)||Yt(n))t.push(n);else if(Ze(n)){let a=n.charCodeAt(0)+(Ge-Ve),r=String.fromCharCode(a);t.push(r)}else t.push(n)}),t.join("")}var Zt=Ut((e,t,n)=>{let a=Ka();return a=e?Ua(a):a,a=t?Ha(a):a,n&&(a=zt(a,n)),a},X);function ze(e="",t={},n){let a;return n?a=t:(a=Le(t),n=Zt(a.IMEMode,a.useObsoleteKana,a.customKanaMapping)),Wa(e,a,n).map(r=>{let[o,s,i]=r;if(i===null)return e.slice(o);let l=a.IMEMode===Nt.HIRAGANA,p=a.IMEMode===Nt.KATAKANA||[...e.slice(o,s)].every(qa);return l||!p?i:be(i)}).join("")}function Wa(e="",t={},n){let{IMEMode:a,useObsoleteKana:r,customKanaMapping:o}=t;return n||(n=Zt(a,r,o)),qt(e.toLowerCase(),n,!a)}function Ja(e=""){return N(e)?!1:Ia.some(([t,n])=>ne(e,t,n))}function se(e="",t){let n=te(t)==="regexp";return N(e)?!1:[...e].every(a=>{let r=Ja(a);return n?r||t.test(a):r})}function we(e=""){return ne(e,Ge,oa)}function za(e=""){return N(e)?!1:Ze(e)||we(e)}function Qt(e=""){return N(e)?!1:[...e].every(za)}function Va(e=""){return N(e)?!1:[...e].every(Ze)}function Xt(e=""){return N(e)?!1:[...e].every(we)}function Ga(e=""){return N(e)?!1:e.charCodeAt(0)===ca}function Ya(e=""){return ne(e,sa,ia)||Ga(e)}function Za(e=""){return N(e)?!1:[...e].every(Ya)}function en(e="",t={passKanji:!0}){let n=[...e],a=!1;return t.passKanji||(a=n.some(Za)),(n.some(Va)||n.some(Xt))&&n.some(se)&&!a}var Qa=(e,t)=>oe(e)&&t<1,Xa=(e,t)=>oe(e)&&t>0,er=e=>["\u30F6","\u30F5"].includes(e),tr={a:"\u3042",i:"\u3044",u:"\u3046",e:"\u3048",o:"\u3046"};function Ee(e="",t,{isDestinationRomaji:n,convertLongVowelMark:a}={}){let r="";return e.split("").reduce((o,s,i)=>{if(Yt(s)||Qa(s,i)||er(s))return o.concat(s);if(a&&r&&Xa(s,i)){let l=t(r).slice(-1);return we(e[i-1])&&l==="o"&&n?o.concat("\u304A"):o.concat(tr[l])}if(!oe(s)&&we(s)){let l=s.charCodeAt(0)+(Ve-Ge),p=String.fromCharCode(l);return r=p,o.concat(p)}return r="",o.concat(s)},[]).join("")}var We=null,nr={\u3042:"a",\u3044:"i",\u3046:"u",\u3048:"e",\u304A:"o",\u304B:"ka",\u304D:"ki",\u304F:"ku",\u3051:"ke",\u3053:"ko",\u3055:"sa",\u3057:"shi",\u3059:"su",\u305B:"se",\u305D:"so",\u305F:"ta",\u3061:"chi",\u3064:"tsu",\u3066:"te",\u3068:"to",\u306A:"na",\u306B:"ni",\u306C:"nu",\u306D:"ne",\u306E:"no",\u306F:"ha",\u3072:"hi",\u3075:"fu",\u3078:"he",\u307B:"ho",\u307E:"ma",\u307F:"mi",\u3080:"mu",\u3081:"me",\u3082:"mo",\u3089:"ra",\u308A:"ri",\u308B:"ru",\u308C:"re",\u308D:"ro",\u3084:"ya",\u3086:"yu",\u3088:"yo",\u308F:"wa",\u3090:"wi",\u3091:"we",\u3092:"wo",\u3093:"n",\u304C:"ga",\u304E:"gi",\u3050:"gu",\u3052:"ge",\u3054:"go",\u3056:"za",\u3058:"ji",\u305A:"zu",\u305C:"ze",\u305E:"zo",\u3060:"da",\u3062:"ji",\u3065:"zu",\u3067:"de",\u3069:"do",\u3070:"ba",\u3073:"bi",\u3076:"bu",\u3079:"be",\u307C:"bo",\u3071:"pa",\u3074:"pi",\u3077:"pu",\u307A:"pe",\u307D:"po",\u3094\u3041:"va",\u3094\u3043:"vi",\u3094:"vu",\u3094\u3047:"ve",\u3094\u3049:"vo"},ar={"\u3002":".","\u3001":",","\uFF1A":":","\u30FB":"/","\uFF01":"!","\uFF1F":"?","\u301C":"~",\u30FC:"-","\u300C":"\u2018","\u300D":"\u2019","\u300E":"\u201C","\u300F":"\u201D","\uFF3B":"[","\uFF3D":"]","\uFF08":"(","\uFF09":")","\uFF5B":"{","\uFF5D":"}","\u3000":" "},rr=["\u3042","\u3044","\u3046","\u3048","\u304A","\u3084","\u3086","\u3088"],Je={\u3083:"ya",\u3085:"yu",\u3087:"yo"},or={\u3043:"yi",\u3047:"ye"},sr={\u3041:"a",\u3043:"i",\u3045:"u",\u3047:"e",\u3049:"o"},ir=["\u304D","\u306B","\u3072","\u307F","\u308A","\u304E","\u3073","\u3074","\u3094","\u304F","\u3075"],cr={\u3057:"sh",\u3061:"ch",\u3058:"j",\u3062:"j"},lr={\u3063:"",\u3083:"ya",\u3085:"yu",\u3087:"yo",\u3041:"a",\u3043:"i",\u3045:"u",\u3047:"e",\u3049:"o"},Ft={b:"b",c:"t",d:"d",f:"f",g:"g",h:"h",j:"j",k:"k",m:"m",p:"p",q:"q",r:"r",s:"s",t:"t",v:"v",w:"w",x:"x",z:"z"};function ur(){return We==null&&(We=pr()),We}function dr(e){switch(e){case Kt.HEPBURN:return ur();default:return{}}}function pr(){let e=Ye(nr),t=a=>Wt(e,a),n=(a,r)=>{t(a)[""]=r};return Object.entries(ar).forEach(([a,r])=>{t(a)[""]=r}),[...Object.entries(Je),...Object.entries(sr)].forEach(([a,r])=>{n(a,r)}),ir.forEach(a=>{let r=t(a)[""][0];Object.entries(Je).forEach(([o,s])=>{n(a+o,r+s)}),Object.entries(or).forEach(([o,s])=>{n(a+o,r+s)})}),Object.entries(cr).forEach(([a,r])=>{Object.entries(Je).forEach(([o,s])=>{n(a+o,r+s[1])}),n(`${a}\u3043`,`${r}yi`),n(`${a}\u3047`,`${r}e`)}),e.\u3063=tn(e),Object.entries(lr).forEach(([a,r])=>{n(a,r)}),rr.forEach(a=>{n(`\u3093${a}`,`n'${t(a)[""]}`)}),Object.freeze(JSON.parse(JSON.stringify(e)))}function tn(e){return Object.entries(e).reduce((t,[n,a])=>{if(n)t[n]=tn(a);else{let r=a.charAt(0);t[n]=Object.keys(Ft).includes(r)?Ft[r]+a:a}return t},{})}var nn=Ut((e,t)=>{let n=dr(e);return t&&(n=zt(n,t)),n},X);function ee(e="",t={},n){let a=Le(t);return n||(n=nn(a.romanization,a.customRomajiMapping)),mr(e,a,n).map(r=>{let[o,s,i]=r;return a.upcaseKatakana&&Xt(e.slice(o,s))?i.toUpperCase():i}).join("")}function mr(e,t,n){n||(n=nn(t.romanization,t.customRomajiMapping));let a=Object.assign({},{isDestinationRomaji:!0},t);return qt(Ee(e,ee,a),n,!t.IMEMode)}function an(e=""){return N(e)?!1:Ba.some(([t,n])=>ne(e,t,n))}function rn(e="",t={}){let n=Le(t);if(n.passRomaji)return Ee(e,ee,n);if(en(e,{passKanji:!0})){let a=Ee(e,ee,n);return ze(a.toLowerCase(),n)}return se(e)||an(e)?ze(e.toLowerCase(),n):Ee(e,ee,n)}function on(e="",t={}){let n=Le(t);if(n.passRomaji)return be(e);if(en(e)||se(e)||an(e)){let a=ze(e.toLowerCase(),n);return be(a)}return be(e)}var ae=(e,t)=>{let n,a=(...r)=>{let o=()=>{clearTimeout(n),e.apply(void 0,r)};clearTimeout(n),n=setTimeout(o,t)};return a.cancel=()=>clearTimeout(n),a},K=(e=[])=>{let t=new Set;return e.filter(Boolean).forEach(n=>{let a=String(n).toLowerCase();t.add(a),Qt(a)&&t.add(ee(a)),se(a)&&(t.add(rn(a)),t.add(on(a)))}),Array.from(t).join(" ")};function H(e){return Array.isArray?Array.isArray(e):fn(e)==="[object Array]"}var hr=1/0;function gr(e){if(typeof e=="string")return e;let t=e+"";return t=="0"&&1/e==-hr?"-0":t}function vr(e){return e==null?"":gr(e)}function R(e){return typeof e=="string"}function pn(e){return typeof e=="number"}function yr(e){return e===!0||e===!1||br(e)&&fn(e)=="[object Boolean]"}function mn(e){return typeof e=="object"}function br(e){return mn(e)&&e!==null}function O(e){return e!=null}function Qe(e){return!e.trim().length}function fn(e){return e==null?e===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}var Er="Incorrect 'index' type",wr=e=>`Invalid value for key ${e}`,Lr=e=>`Pattern length exceeds max of ${e}.`,Ar=e=>`Missing ${e} property in key`,Cr=e=>`Property 'weight' in key '${e}' must be a positive integer`,sn=Object.prototype.hasOwnProperty,Xe=class{constructor(t){this._keys=[],this._keyMap={};let n=0;t.forEach(a=>{let r=hn(a);this._keys.push(r),this._keyMap[r.id]=r,n+=r.weight}),this._keys.forEach(a=>{a.weight/=n})}get(t){return this._keyMap[t]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}};function hn(e){let t=null,n=null,a=null,r=1,o=null;if(R(e)||H(e))a=e,t=cn(e),n=et(e);else{if(!sn.call(e,"name"))throw new Error(Ar("name"));let s=e.name;if(a=s,sn.call(e,"weight")&&(r=e.weight,r<=0))throw new Error(Cr(s));t=cn(s),n=et(s),o=e.getFn}return{path:t,id:n,weight:r,src:a,getFn:o}}function cn(e){return H(e)?e:e.split(".")}function et(e){return H(e)?e.join("."):e}function xr(e,t){let n=[],a=!1,r=(o,s,i)=>{if(O(o))if(!s[i])n.push(o);else{let l=s[i],p=o[l];if(!O(p))return;if(i===s.length-1&&(R(p)||pn(p)||yr(p)))n.push(vr(p));else if(H(p)){a=!0;for(let m=0,f=p.length;m<f;m+=1)r(p[m],s,i+1)}else s.length&&r(p,s,i+1)}};return r(e,R(t)?t.split("."):t,0),a?n:n[0]}var Tr={includeMatches:!1,findAllMatches:!1,minMatchCharLength:1},Sr={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1},kr={location:0,threshold:.6,distance:100},Dr={useExtendedSearch:!1,getFn:xr,ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1},b={...Sr,...Tr,...kr,...Dr},Mr=/[^ ]+/g;function Ir(e=1,t=3){let n=new Map,a=Math.pow(10,t);return{get(r){let o=r.match(Mr).length;if(n.has(o))return n.get(o);let s=1/Math.pow(o,.5*e),i=parseFloat(Math.round(s*a)/a);return n.set(o,i),i},clear(){n.clear()}}}var ie=class{constructor({getFn:t=b.getFn,fieldNormWeight:n=b.fieldNormWeight}={}){this.norm=Ir(n,3),this.getFn=t,this.isCreated=!1,this.setIndexRecords()}setSources(t=[]){this.docs=t}setIndexRecords(t=[]){this.records=t}setKeys(t=[]){this.keys=t,this._keysMap={},t.forEach((n,a)=>{this._keysMap[n.id]=a})}create(){this.isCreated||!this.docs.length||(this.isCreated=!0,R(this.docs[0])?this.docs.forEach((t,n)=>{this._addString(t,n)}):this.docs.forEach((t,n)=>{this._addObject(t,n)}),this.norm.clear())}add(t){let n=this.size();R(t)?this._addString(t,n):this._addObject(t,n)}removeAt(t){this.records.splice(t,1);for(let n=t,a=this.size();n<a;n+=1)this.records[n].i-=1}getValueForItemAtKeyId(t,n){return t[this._keysMap[n]]}size(){return this.records.length}_addString(t,n){if(!O(t)||Qe(t))return;let a={v:t,i:n,n:this.norm.get(t)};this.records.push(a)}_addObject(t,n){let a={i:n,$:{}};this.keys.forEach((r,o)=>{let s=r.getFn?r.getFn(t):this.getFn(t,r.path);if(O(s)){if(H(s)){let i=[],l=[{nestedArrIndex:-1,value:s}];for(;l.length;){let{nestedArrIndex:p,value:m}=l.pop();if(O(m))if(R(m)&&!Qe(m)){let f={v:m,i:p,n:this.norm.get(m)};i.push(f)}else H(m)&&m.forEach((f,h)=>{l.push({nestedArrIndex:h,value:f})})}a.$[o]=i}else if(R(s)&&!Qe(s)){let i={v:s,n:this.norm.get(s)};a.$[o]=i}}}),this.records.push(a)}toJSON(){return{keys:this.keys,records:this.records}}};function gn(e,t,{getFn:n=b.getFn,fieldNormWeight:a=b.fieldNormWeight}={}){let r=new ie({getFn:n,fieldNormWeight:a});return r.setKeys(e.map(hn)),r.setSources(t),r.create(),r}function Br(e,{getFn:t=b.getFn,fieldNormWeight:n=b.fieldNormWeight}={}){let{keys:a,records:r}=e,o=new ie({getFn:t,fieldNormWeight:n});return o.setKeys(a),o.setIndexRecords(r),o}function Ae(e,{errors:t=0,currentLocation:n=0,expectedLocation:a=0,distance:r=b.distance,ignoreLocation:o=b.ignoreLocation}={}){let s=t/e.length;if(o)return s;let i=Math.abs(a-n);return r?s+i/r:i?1:s}function jr(e=[],t=b.minMatchCharLength){let n=[],a=-1,r=-1,o=0;for(let s=e.length;o<s;o+=1){let i=e[o];i&&a===-1?a=o:!i&&a!==-1&&(r=o-1,r-a+1>=t&&n.push([a,r]),a=-1)}return e[o-1]&&o-a>=t&&n.push([a,o-1]),n}var G=32;function Nr(e,t,n,{location:a=b.location,distance:r=b.distance,threshold:o=b.threshold,findAllMatches:s=b.findAllMatches,minMatchCharLength:i=b.minMatchCharLength,includeMatches:l=b.includeMatches,ignoreLocation:p=b.ignoreLocation}={}){if(t.length>G)throw new Error(Lr(G));let m=t.length,f=e.length,h=Math.max(0,Math.min(a,f)),g=o,v=h,E=i>1||l,w=E?Array(f):[],y;for(;(y=e.indexOf(t,v))>-1;){let x=Ae(t,{currentLocation:y,expectedLocation:h,distance:r,ignoreLocation:p});if(g=Math.min(x,g),v=y+m,E){let A=0;for(;A<m;)w[y+A]=1,A+=1}}v=-1;let L=[],C=1,D=m+f,B=1<<m-1;for(let x=0;x<m;x+=1){let A=0,T=D;for(;A<T;)Ae(t,{errors:x,currentLocation:h+T,expectedLocation:h,distance:r,ignoreLocation:p})<=g?A=T:D=T,T=Math.floor((D-A)/2+A);D=T;let J=Math.max(1,h-T+1),z=s?f:Math.min(h+T,f)+m,j=Array(z+2);j[z+1]=(1<<x)-1;for(let _=z;_>=J;_-=1){let ve=_-1,Ct=n[e.charAt(ve)];if(E&&(w[ve]=+!!Ct),j[_]=(j[_+1]<<1|1)&Ct,x&&(j[_]|=(L[_+1]|L[_])<<1|1|L[_+1]),j[_]&B&&(C=Ae(t,{errors:x,currentLocation:ve,expectedLocation:h,distance:r,ignoreLocation:p}),C<=g)){if(g=C,v=ve,v<=h)break;J=Math.max(1,2*h-v)}}if(Ae(t,{errors:x+1,currentLocation:h,expectedLocation:h,distance:r,ignoreLocation:p})>g)break;L=j}let M={isMatch:v>=0,score:Math.max(.001,C)};if(E){let x=jr(w,i);x.length?l&&(M.indices=x):M.isMatch=!1}return M}function Or(e){let t={};for(let n=0,a=e.length;n<a;n+=1){let r=e.charAt(n);t[r]=(t[r]||0)|1<<a-n-1}return t}var Ce=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e,xe=class{constructor(t,{location:n=b.location,threshold:a=b.threshold,distance:r=b.distance,includeMatches:o=b.includeMatches,findAllMatches:s=b.findAllMatches,minMatchCharLength:i=b.minMatchCharLength,isCaseSensitive:l=b.isCaseSensitive,ignoreDiacritics:p=b.ignoreDiacritics,ignoreLocation:m=b.ignoreLocation}={}){if(this.options={location:n,threshold:a,distance:r,includeMatches:o,findAllMatches:s,minMatchCharLength:i,isCaseSensitive:l,ignoreDiacritics:p,ignoreLocation:m},t=l?t:t.toLowerCase(),t=p?Ce(t):t,this.pattern=t,this.chunks=[],!this.pattern.length)return;let f=(g,v)=>{this.chunks.push({pattern:g,alphabet:Or(g),startIndex:v})},h=this.pattern.length;if(h>G){let g=0,v=h%G,E=h-v;for(;g<E;)f(this.pattern.substr(g,G),g),g+=G;if(v){let w=h-G;f(this.pattern.substr(w),w)}}else f(this.pattern,0)}searchIn(t){let{isCaseSensitive:n,ignoreDiacritics:a,includeMatches:r}=this.options;if(t=n?t:t.toLowerCase(),t=a?Ce(t):t,this.pattern===t){let E={isMatch:!0,score:0};return r&&(E.indices=[[0,t.length-1]]),E}let{location:o,distance:s,threshold:i,findAllMatches:l,minMatchCharLength:p,ignoreLocation:m}=this.options,f=[],h=0,g=!1;this.chunks.forEach(({pattern:E,alphabet:w,startIndex:y})=>{let{isMatch:L,score:C,indices:D}=Nr(t,E,w,{location:o+y,distance:s,threshold:i,findAllMatches:l,minMatchCharLength:p,includeMatches:r,ignoreLocation:m});L&&(g=!0),h+=C,L&&D&&(f=[...f,...D])});let v={isMatch:g,score:g?h/this.chunks.length:1};return g&&r&&(v.indices=f),v}},P=class{constructor(t){this.pattern=t}static isMultiMatch(t){return ln(t,this.multiRegex)}static isSingleMatch(t){return ln(t,this.singleRegex)}search(){}};function ln(e,t){let n=e.match(t);return n?n[1]:null}var tt=class extends P{constructor(t){super(t)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(t){let n=t===this.pattern;return{isMatch:n,score:n?0:1,indices:[0,this.pattern.length-1]}}},nt=class extends P{constructor(t){super(t)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(t){let a=t.indexOf(this.pattern)===-1;return{isMatch:a,score:a?0:1,indices:[0,t.length-1]}}},at=class extends P{constructor(t){super(t)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(t){let n=t.startsWith(this.pattern);return{isMatch:n,score:n?0:1,indices:[0,this.pattern.length-1]}}},rt=class extends P{constructor(t){super(t)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(t){let n=!t.startsWith(this.pattern);return{isMatch:n,score:n?0:1,indices:[0,t.length-1]}}},ot=class extends P{constructor(t){super(t)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(t){let n=t.endsWith(this.pattern);return{isMatch:n,score:n?0:1,indices:[t.length-this.pattern.length,t.length-1]}}},st=class extends P{constructor(t){super(t)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(t){let n=!t.endsWith(this.pattern);return{isMatch:n,score:n?0:1,indices:[0,t.length-1]}}},Te=class extends P{constructor(t,{location:n=b.location,threshold:a=b.threshold,distance:r=b.distance,includeMatches:o=b.includeMatches,findAllMatches:s=b.findAllMatches,minMatchCharLength:i=b.minMatchCharLength,isCaseSensitive:l=b.isCaseSensitive,ignoreDiacritics:p=b.ignoreDiacritics,ignoreLocation:m=b.ignoreLocation}={}){super(t),this._bitapSearch=new xe(t,{location:n,threshold:a,distance:r,includeMatches:o,findAllMatches:s,minMatchCharLength:i,isCaseSensitive:l,ignoreDiacritics:p,ignoreLocation:m})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(t){return this._bitapSearch.searchIn(t)}},Se=class extends P{constructor(t){super(t)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(t){let n=0,a,r=[],o=this.pattern.length;for(;(a=t.indexOf(this.pattern,n))>-1;)n=a+o,r.push([a,n-1]);let s=!!r.length;return{isMatch:s,score:s?0:1,indices:r}}},it=[tt,Se,at,rt,st,ot,nt,Te],un=it.length,$r=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/,_r="|";function Rr(e,t={}){return e.split(_r).map(n=>{let a=n.trim().split($r).filter(o=>o&&!!o.trim()),r=[];for(let o=0,s=a.length;o<s;o+=1){let i=a[o],l=!1,p=-1;for(;!l&&++p<un;){let m=it[p],f=m.isMultiMatch(i);f&&(r.push(new m(f,t)),l=!0)}if(!l)for(p=-1;++p<un;){let m=it[p],f=m.isSingleMatch(i);if(f){r.push(new m(f,t));break}}}return r})}var Pr=new Set([Te.type,Se.type]),ct=class{constructor(t,{isCaseSensitive:n=b.isCaseSensitive,ignoreDiacritics:a=b.ignoreDiacritics,includeMatches:r=b.includeMatches,minMatchCharLength:o=b.minMatchCharLength,ignoreLocation:s=b.ignoreLocation,findAllMatches:i=b.findAllMatches,location:l=b.location,threshold:p=b.threshold,distance:m=b.distance}={}){this.query=null,this.options={isCaseSensitive:n,ignoreDiacritics:a,includeMatches:r,minMatchCharLength:o,findAllMatches:i,ignoreLocation:s,location:l,threshold:p,distance:m},t=n?t:t.toLowerCase(),t=a?Ce(t):t,this.pattern=t,this.query=Rr(this.pattern,this.options)}static condition(t,n){return n.useExtendedSearch}searchIn(t){let n=this.query;if(!n)return{isMatch:!1,score:1};let{includeMatches:a,isCaseSensitive:r,ignoreDiacritics:o}=this.options;t=r?t:t.toLowerCase(),t=o?Ce(t):t;let s=0,i=[],l=0;for(let p=0,m=n.length;p<m;p+=1){let f=n[p];i.length=0,s=0;for(let h=0,g=f.length;h<g;h+=1){let v=f[h],{isMatch:E,indices:w,score:y}=v.search(t);if(E){if(s+=1,l+=y,a){let L=v.constructor.type;Pr.has(L)?i=[...i,...w]:i.push(w)}}else{l=0,s=0,i.length=0;break}}if(s){let h={isMatch:!0,score:l/s};return a&&(h.indices=i),h}}return{isMatch:!1,score:1}}},lt=[];function Fr(...e){lt.push(...e)}function ut(e,t){for(let n=0,a=lt.length;n<a;n+=1){let r=lt[n];if(r.condition(e,t))return new r(e,t)}return new xe(e,t)}var ke={AND:"$and",OR:"$or"},dt={PATH:"$path",PATTERN:"$val"},pt=e=>!!(e[ke.AND]||e[ke.OR]),Kr=e=>!!e[dt.PATH],Hr=e=>!H(e)&&mn(e)&&!pt(e),dn=e=>({[ke.AND]:Object.keys(e).map(t=>({[t]:e[t]}))});function vn(e,t,{auto:n=!0}={}){let a=r=>{let o=Object.keys(r),s=Kr(r);if(!s&&o.length>1&&!pt(r))return a(dn(r));if(Hr(r)){let l=s?r[dt.PATH]:o[0],p=s?r[dt.PATTERN]:r[l];if(!R(p))throw new Error(wr(l));let m={keyId:et(l),pattern:p};return n&&(m.searcher=ut(p,t)),m}let i={children:[],operator:o[0]};return o.forEach(l=>{let p=r[l];H(p)&&p.forEach(m=>{i.children.push(a(m))})}),i};return pt(e)||(e=dn(e)),a(e)}function Ur(e,{ignoreFieldNorm:t=b.ignoreFieldNorm}){e.forEach(n=>{let a=1;n.matches.forEach(({key:r,norm:o,score:s})=>{let i=r?r.weight:null;a*=Math.pow(s===0&&i?Number.EPSILON:s,(i||1)*(t?1:o))}),n.score=a})}function qr(e,t){let n=e.matches;t.matches=[],O(n)&&n.forEach(a=>{if(!O(a.indices)||!a.indices.length)return;let{indices:r,value:o}=a,s={indices:r,value:o};a.key&&(s.key=a.key.src),a.idx>-1&&(s.refIndex=a.idx),t.matches.push(s)})}function Wr(e,t){t.score=e.score}function Jr(e,t,{includeMatches:n=b.includeMatches,includeScore:a=b.includeScore}={}){let r=[];return n&&r.push(qr),a&&r.push(Wr),e.map(o=>{let{idx:s}=o,i={item:t[s],refIndex:s};return r.length&&r.forEach(l=>{l(o,i)}),i})}var U=class{constructor(t,n={},a){this.options={...b,...n},this.options.useExtendedSearch,this._keyStore=new Xe(this.options.keys),this.setCollection(t,a)}setCollection(t,n){if(this._docs=t,n&&!(n instanceof ie))throw new Error(Er);this._myIndex=n||gn(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(t){O(t)&&(this._docs.push(t),this._myIndex.add(t))}remove(t=()=>!1){let n=[];for(let a=0,r=this._docs.length;a<r;a+=1){let o=this._docs[a];t(o,a)&&(this.removeAt(a),a-=1,r-=1,n.push(o))}return n}removeAt(t){this._docs.splice(t,1),this._myIndex.removeAt(t)}getIndex(){return this._myIndex}search(t,{limit:n=-1}={}){let{includeMatches:a,includeScore:r,shouldSort:o,sortFn:s,ignoreFieldNorm:i}=this.options,l=R(t)?R(this._docs[0])?this._searchStringList(t):this._searchObjectList(t):this._searchLogical(t);return Ur(l,{ignoreFieldNorm:i}),o&&l.sort(s),pn(n)&&n>-1&&(l=l.slice(0,n)),Jr(l,this._docs,{includeMatches:a,includeScore:r})}_searchStringList(t){let n=ut(t,this.options),{records:a}=this._myIndex,r=[];return a.forEach(({v:o,i:s,n:i})=>{if(!O(o))return;let{isMatch:l,score:p,indices:m}=n.searchIn(o);l&&r.push({item:o,idx:s,matches:[{score:p,value:o,norm:i,indices:m}]})}),r}_searchLogical(t){let n=vn(t,this.options),a=(i,l,p)=>{if(!i.children){let{keyId:f,searcher:h}=i,g=this._findMatches({key:this._keyStore.get(f),value:this._myIndex.getValueForItemAtKeyId(l,f),searcher:h});return g&&g.length?[{idx:p,item:l,matches:g}]:[]}let m=[];for(let f=0,h=i.children.length;f<h;f+=1){let g=i.children[f],v=a(g,l,p);if(v.length)m.push(...v);else if(i.operator===ke.AND)return[]}return m},r=this._myIndex.records,o={},s=[];return r.forEach(({$:i,i:l})=>{if(O(i)){let p=a(n,i,l);p.length&&(o[l]||(o[l]={idx:l,item:i,matches:[]},s.push(o[l])),p.forEach(({matches:m})=>{o[l].matches.push(...m)}))}}),s}_searchObjectList(t){let n=ut(t,this.options),{keys:a,records:r}=this._myIndex,o=[];return r.forEach(({$:s,i})=>{if(!O(s))return;let l=[];a.forEach((p,m)=>{l.push(...this._findMatches({key:p,value:s[m],searcher:n}))}),l.length&&o.push({idx:i,item:s,matches:l})}),o}_findMatches({key:t,value:n,searcher:a}){if(!O(n))return[];let r=[];if(H(n))n.forEach(({v:o,i:s,n:i})=>{if(!O(o))return;let{isMatch:l,score:p,indices:m}=a.searchIn(o);l&&r.push({score:p,key:t,value:o,idx:s,norm:i,indices:m})});else{let{v:o,n:s}=n,{isMatch:i,score:l,indices:p}=a.searchIn(o);i&&r.push({score:l,key:t,value:o,norm:s,indices:p})}return r}};U.version="7.1.0";U.createIndex=gn;U.parseIndex=Br;U.config=b;U.parseQuery=vn;Fr(ct);var zr=/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/,Vr="https://jdict.net/api/v1/search",Gr="https://jotoba.de/api/search/words",Yr=1e4,Zr=24*60*60*1e3,yn=1e3,bn=2,Qr=1e3,mt=0,De=0;function Xr(e){return new Promise((t,n)=>setTimeout(()=>n(new Error("Request timeout")),e))}function eo(e){let t=Qr*Math.pow(2,e);return new Promise(n=>setTimeout(n,t))}function to(e){return["Request timeout","Rate limit exceeded","Server error","Failed to fetch","NetworkError"].some(n=>e.message.includes(n))}async function ht(e,t={},n,a=bn){let r=Date.now();if(r-mt<yn&&await new Promise(o=>setTimeout(o,yn-(r-mt))),mt=Date.now(),n.aborted)throw new DOMException("Request was aborted","AbortError");try{let o=await Promise.race([fetch(e,{...t,signal:n}),Xr(Yr)]);if(!o.ok)throw o.status===429?new Error("Rate limit exceeded"):o.status>=500?new Error(`Server error: ${o.status}`):new Error(`HTTP error: ${o.status}`);return o}catch(o){if(o.name==="AbortError")throw o;if(a>0&&to(o))return console.warn(`Request failed, retrying... (${a} attempts left):`,o.message),await eo(bn-a),ht(e,t,n,a-1);throw o}}function no(e){if(!e||typeof e!="string")return[];try{let t=/「(.*?)」/;return e.split(";").map(n=>n.trim()).filter(Boolean).map(n=>{let a=n.match(t);if(a){let r=a[1];return{kanji:n.replace(t,"").trim()||r,kana:r}}return{kanji:n,kana:n}})}catch(t){return console.warn("Error parsing suggest_mean:",t),[]}}function ao(e,t){if(!e?.list?.length)return null;try{return{words:t?e.list.map(a=>{let r=(a.suggest_mean||"").split(";").map(i=>i.trim()).filter(Boolean),o=(a.word||"").match(/「(.*?)」/);return{reading:{kanji:(a.word||"").replace(/「(.*?)」/,"").trim()||(o?o[1]:""),kana:o?o[1]:""},senses:[{glosses:r}]}}):e.list.map(a=>({reading:{kanji:a.word||"",kana:""},senses:no(a.suggest_mean).map(r=>({glosses:[r.kanji],reading:r.kana}))})),kanji:[]}}catch(n){return console.warn("Error transforming JDict data:",n),null}}async function ro(e,t,n){let a=t?"jp_vi":"vi_jp",r=`${Vr}?keyword=${encodeURIComponent(e.trim())}&dict=${a}`,s=await(await ht(r,{},n)).json();return ao(s,t)}async function oo(e,t,n){let r=await(await ht(Gr,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:e.trim(),language:t?"Japanese":"English",no_english:!1})},n)).json();if(!r||!r.words?.length&&!r.kanji?.length)throw new Error("No results found");return{words:r.words||[],kanji:r.kanji||[]}}async function so(e,t){try{let n=await e.get("dictionary_cache",t);if(n?.timestamp&&Date.now()-n.timestamp<Zr)return n;n&&await e.delete("dictionary_cache",t)}catch(n){console.warn("Cache retrieval failed:",n)}return null}async function io(e,t,n){try{await e.put("dictionary_cache",{data:n,lang:d.currentLang,timestamp:Date.now()},t)}catch(a){console.warn("Cache storage failed:",a)}}function ft(e,t){return d.appData?.ui?.[d.currentLang]?.[e]||t}function co(e,t){let n,a={timeout:"searchTimeout","Rate limit":"searchRateLimitError","Server error":"searchServerError",Network:"searchNetworkError","No results":"noResults"},r=Object.keys(a).find(p=>e.message.includes(p))||"default";if(r==="noResults"){re("no-results",{query:t});return}n=ft(a[r],"Could not fetch results. Please try again.");let s=`
        <div class="search-placeholder-box text-center content-anim-fade-in">
            <svg class="w-16 h-16 text-red-400 opacity-80 mb-4 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
            <h3 class="text-xl font-semibold text-primary">${ft("searchErrorTitle","Search Error")}</h3>
            <p class="text-secondary text-base mt-1 max-w-md mx-auto">${n}</p>
            <button class="mt-4 px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark transition-colors" onclick="window.handleExternalSearch('${t.replace(/'/g,"\\'")}', true)">
                ${ft("retryButton","Retry")}
            </button>
        </div>`,i=c.externalSearchTab.querySelector(".placeholder-container"),l=c.externalSearchTab.querySelector(".results-container");l&&(l.style.display="none"),i&&(i.style.display="flex",i.innerHTML=s)}async function lo(e,t,n){if(d.currentLang==="vi")try{let a=await ro(e,t,n);if(a)return a;console.log("JDict failed or returned no results, falling back to Jotoba.")}catch(a){if(a.name==="AbortError")throw a;console.warn("JDict search failed, falling back to Jotoba:",a.message)}return await oo(e,t,n)}async function uo(e,t=!1,n=!1){let a=++De,r=new AbortController;window.activeSearchController&&window.activeSearchController.abort(),window.activeSearchController=r;let{signal:o}=r,s=e.trim();if(s.length===0){re("prompt",{},!0);return}let i=await k;if(!t){let l=await so(i,s);if(l&&l.lang===d.currentLang){a===De&&re("results",{results:l.data,query:s},n);return}}n||re("searching",{query:s},!1);try{let l=zr.test(s),p=await lo(s,l,o);a===De&&(await io(i,s,p),re("results",{results:p,query:s},n))}catch(l){l.name!=="AbortError"&&a===De&&(console.error("External Search Error:",l),co(l,s))}finally{window.activeSearchController===r&&(window.activeSearchController=null)}}window.handleExternalSearch=ae(uo,300);var gt=window.handleExternalSearch;var Y=new Map;function $(e,t={}){let n=d.appData.ui?.[d.currentLang]?.[e]||d.appData.ui?.en?.[e]||`[${e}]`;for(let[a,r]of Object.entries(t))n=n.replace(`{${a}}`,r);return n}function Me(){return window.innerWidth<=768?c.mobileSearchInput:c.searchInput}function po(e){if(!Y.has(e))return;let t=Y.get(e);for(let n of t)n.originalHTML&&(n.element.innerHTML=n.originalHTML,delete n.originalHTML)}function mo(e,t){if(!t)return;let n=Y.get(d.activeTab)?.find(i=>i.element===e);n&&!n.originalHTML&&(n.originalHTML=e.innerHTML);let a=new RegExp(`(${t.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")})`,"gi"),r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),o=[],s;for(;s=r.nextNode();)a.test(s.nodeValue)&&o.push(s);o.forEach(i=>{let l=document.createDocumentFragment();i.nodeValue.split(a).forEach(p=>{if(p.toLowerCase()===t.toLowerCase()){let m=document.createElement("mark");m.className="search-highlight",m.textContent=p,l.appendChild(m)}else l.appendChild(document.createTextNode(p))}),i.parentNode?.replaceChild(l,i)})}function En(e,t,n){d.progress[e]||(d.progress[e]=[]);let a=d.progress[e],r=a.indexOf(t);r>-1?(a.splice(r,1),n.classList.remove("learned")):(a.push(t),n.classList.add("learned")),Tn()}function Z(e){if(d.fuseInstances[e]||!d.appData[e])return;let t=document.getElementById(e);if(!t)return;let n=Array.from(t.querySelectorAll("[data-search-item], [data-search]"));Y.set(e,n.map(r=>({element:r})));let a=n.map((r,o)=>({id:r.dataset.itemId||`${e}-${o}`,element:r,searchData:r.dataset.searchItem||r.dataset.search}));a.length>0&&(d.fuseInstances[e]=new U(a,{keys:["searchData"],includeScore:!0,threshold:.3,ignoreLocation:!0}))}var Ie=ae(()=>{let e=Me().value.trim(),t=document.querySelector(".tab-content.active");if(!t)return;let n=t.id;if(n==="external-search"){gt(e);return}let a=Y.get(n)?.map(i=>i.element)||[],r=t.querySelectorAll(".search-wrapper");if(po(n),!e){a.forEach(i=>{i.style.display=""}),r.forEach(i=>{i.style.display=""});return}let o=d.fuseInstances[n];if(!o)return;a.forEach(i=>{i.style.display="none"}),r.forEach(i=>{i.style.display="none"}),o.search(e).forEach(i=>{let l=i.item.element;l.style.display="",mo(l,e);let p=l.closest(".search-wrapper");p&&(p.style.display="");let m=l.closest(".accordion-wrapper");if(m){let f=m.querySelector(".accordion-button");f&&!f.classList.contains("open")&&f.classList.add("open")}})},300);function ce(e,t=!1){d.currentLang=e,Q("language",e),d.renderedTabs&&d.renderedTabs.clear(),Y.clear();let n=d.appData.ui,a=o=>(n?.[e]?.[o]||n?.en?.[o]||`[${o}]`).replace("{level}",d.currentLevel.toUpperCase());document.querySelectorAll("[data-lang-key]").forEach(o=>{o.textContent=a(o.dataset.langKey)}),document.querySelectorAll("[data-lang-placeholder-key]").forEach(o=>{o.placeholder=a(o.dataset.langPlaceholderKey)}),document.querySelectorAll(".lang-switch button").forEach(o=>o.classList.toggle("active",o.dataset.lang===e)),document.querySelectorAll(".lang-switch").forEach(pe);let r=document.querySelector(".nav-item.active");if(r&&c.mobileHeaderTitle){let o=r.querySelector("span"),s=o?.dataset.langKey;c.mobileHeaderTitle.textContent=s?a(s):o?.textContent||""}if(!t){let o=document.querySelector(".tab-content.active");o&&ue(o.id,null,!0,!0,!0),W()}bt(d.activeTab)}function wn(e){let t=e.target.checked,n=t?"dark":"light";document.documentElement.classList.toggle("dark-mode",t),Q("theme",n);try{localStorage.setItem("theme",n)}catch(r){console.warn("Could not save theme to localStorage.",r)}document.querySelectorAll(".theme-switch input").forEach(r=>{r!==e.target&&(r.checked=t)});let a=document.getElementById("theme-emoji");a&&(a.textContent=t?"\u{1F319}":"\u2600\uFE0F")}function fo(){if(!c.loadingOverlay)return;let e=c.loadingOverlay.cloneNode(!0);c.loadingOverlay.parentNode.replaceChild(e,c.loadingOverlay),c.loadingOverlay=e,c.loadingOverlay.innerHTML='<div class="loader"></div>',c.loadingOverlay.classList.remove("hidden"),requestAnimationFrame(()=>{c.loadingOverlay.style.opacity="1"})}function ho(){return new Promise(e=>{if(!c.loadingOverlay||c.loadingOverlay.style.opacity==="0"){e();return}let t=n=>{n.target===c.loadingOverlay&&(c.loadingOverlay.classList.add("hidden"),c.loadingOverlay.removeEventListener("transitionend",t),e())};c.loadingOverlay.addEventListener("transitionend",t),c.loadingOverlay.style.opacity="0",setTimeout(()=>{t({target:c.loadingOverlay})},500)})}async function go(e){d.currentLevel=e,await Q("currentLevel",e);let t=[Ne(e),k.then(i=>i.get("progress",d.currentLevel)),k.then(i=>i.get("settings","levelSettings"))],[n,a,r]=await Promise.all(t);if(d.progress=a||{kanji:[],vocab:[]},d.pinnedTab=r?.[d.currentLevel]?.pinnedTab||null,d.fuseInstances={},d.lastDictionaryQuery="",d.notes.data=new Map,d.notes.originalContent="",d.renderedTabs&&d.renderedTabs.clear(),Y.clear(),!!!await(await k).get("levels",e)){let i=["kanji","vocab","hiragana","katakana","grammar","keyPoints"];Promise.all(i.map(l=>ge(e,l).catch(p=>{console.warn(`Non-critical preload of tab '${l}' failed.`,p)}))).then(()=>console.log(`Pre-loading for level ${e} complete.`))}}async function vo(e,t){document.querySelectorAll(".tab-content").forEach(s=>{s.innerHTML=""}),W(),ce(d.currentLang,!0),document.querySelectorAll(".level-switch-button").forEach(s=>s.classList.toggle("active",s.dataset.levelName===e)),fe(),await Be(e);let n=e===I.defaultLevel,r=window.innerWidth<=768?"external-search":n?"hiragana":"keyPoints",o=d.pinnedTab||r;!n&&(o==="hiragana"||o==="katakana")&&(o="keyPoints",d.pinnedTab=null,await yt(null)),await ue(o,null,!1,t,!0)}async function le(e,t=!1){if(d.isSwitchingLevel||e===d.currentLevel){e===d.currentLevel&&q();return}d.isSwitchingLevel=!0,d.loadingStatus="loading";let n=new Promise(a=>setTimeout(a,500));fo();try{await Promise.all([go(e),n]),await vo(e,t),d.loadingStatus="idle"}catch(a){if(console.error(`Failed to load level ${e}:`,a),d.loadingStatus="error",c.loadingOverlay){let r=$("errorLoadLevelTitle"),o=$("errorLoadLevelBody");F(r,`${a.message}

${o}`)}return}finally{d.isSwitchingLevel=!1,d.loadingStatus!=="error"&&await ho(),q()}}async function yt(e){try{let n=await(await k).get("settings","levelSettings")||{};n[d.currentLevel]={...n[d.currentLevel],pinnedTab:e||null},await Q("levelSettings",n),me(e),fe()}catch(t){console.error("Error saving pinned tab setting:",t)}}function Ln(){let e=document.querySelector(".tab-content.active");if(!e)return;let t=e.id;d.pinnedTab===t&&(c.pinToggle.classList.add("unpinning"),c.pinToggle.addEventListener("animationend",()=>c.pinToggle.classList.remove("unpinning"),{once:!0})),d.pinnedTab=d.pinnedTab===t?null:t,yt(d.pinnedTab)}function An(e,t){e.stopPropagation(),d.pinnedTab=d.pinnedTab===t?null:t,yt(d.pinnedTab)}function yo(e){document.querySelectorAll(".nav-item").forEach(o=>o.classList.toggle("active",o.dataset.tabName===e));let t=document.querySelector(`.nav-item[data-tab-name="${e}"]`),n=window.innerWidth<=768;if(n&&(c.mobileSearchBar&&c.mobileSearchBar.classList.toggle("visible",e!=="progress"),t&&c.mobileHeaderTitle)){let o=t.querySelector("span"),s=o?.dataset.langKey;c.mobileHeaderTitle.textContent=s?$(s):o?.textContent||""}c.pinToggle&&(c.pinToggle.style.display=n?"block":"none",me(e));let r=!["progress","external-search"].includes(e)?"flex":"none";c.desktopNotesBtn&&(c.desktopNotesBtn.style.display=r),c.mobileNotesBtn&&(c.mobileNotesBtn.style.display=r),bt(e)}async function ue(e,t,n=!1,a=!1,r=!1){let o=document.querySelector(".tab-content.active");if(o?.id===e&&!r){q();return}d.activeTab=e,yo(e),q(),o&&(d.tabScrollPositions.set(o.id,window.scrollY),o.classList.remove("active"));let s=document.getElementById(e);if(!s){console.error(`Tab container not found for tab: ${e}`);return}if(s.classList.add("active"),!a){let p=`?level=${d.currentLevel}&tab=${e}`;history.pushState({type:"tab",tabName:e,level:d.currentLevel},"",p)}o?.id==="external-search"&&(d.lastDictionaryQuery=Me().value.trim());let i=!["external-search","progress"].includes(e),l=d.appData[e];if(i)if(l)r||!d.renderedTabs.has(e)?(vt(e),d.renderedTabs.set(e,s.innerHTML)):(s.innerHTML=d.renderedTabs.get(e),Z(e));else if(await(await k).get("levels",d.currentLevel))de(e),d.renderedTabs.delete(e);else{let f=document.getElementById("content-loader-template");s.innerHTML=f?f.innerHTML:'<div class="loader"></div>';try{await ge(d.currentLevel,e),vt(e),d.renderedTabs.set(e,s.innerHTML)}catch(h){console.error(`Error loading data for tab ${e}:`,h);let g=$("errorLoadContentTitle"),v=$("errorLoadContentBody");F(g,`${h.message}

${v}`)}}if(e==="external-search")Me().value=d.lastDictionaryQuery,gt(d.lastDictionaryQuery,!1,!0);else if(e==="progress")W();else{let p=Me();p.value&&(p.value="",Ie())}n||window.scrollTo({top:d.tabScrollPositions.get(e)||0,behavior:"instant"})}function Cn(e,t){let a=document.querySelector(".tab-content.active")?.id===e,r=()=>{requestAnimationFrame(()=>{let o=document.querySelector(`[data-section-title-key="${t}"]`);if(!o)return;o.closest(".accordion-wrapper")&&o.tagName==="BUTTON"&&!o.classList.contains("open")&&o.click(),setTimeout(()=>{let l=o.getBoundingClientRect().top+window.scrollY,p=document.querySelector(".mobile-header.sticky"),m=p?.isConnected&&getComputedStyle(p).position==="sticky"?p.offsetHeight:0;window.scrollTo({top:l-m-20,behavior:"smooth"});let f=o.closest(".progress-item-wrapper, .search-wrapper, .accordion-wrapper");f&&(f.classList.add("is-highlighted"),f.addEventListener("animationend",()=>{f.classList.remove("is-highlighted")},{once:!0}))},100)})};a?r():ue(e,null,!0).then(r)}async function xn(e){if(e===I.defaultLevel){F($("errorTitle","Error"),$("errorDeleteDefaultLevel"));return}if(await je($("confirmDeleteLevelTitle","Confirm Deletion"),$("confirmDeleteLevel",{level:e.toUpperCase()})))try{let n=await k;if(await Promise.all([n.delete("levels",e),n.delete("progress",e),Sn(e)]),d.allAvailableLevels=d.allAvailableLevels.filter(a=>a!==e),d.currentLevel===e)await le(I.defaultLevel);else{let a=await fetch(`${I.dataPath}/levels.json`),r=a.ok?await a.json():{levels:[]},o=await n.getAllKeys("levels");he(r.levels||[I.defaultLevel],o),document.querySelectorAll(".level-switch-button").forEach(s=>s.classList.toggle("active",s.dataset.levelName===d.currentLevel))}F($("successTitle","Success"),$("successDeleteLevel",{level:e.toUpperCase()}))}catch(n){console.error("Failed to delete level:",n),F($("errorTitle","Error"),$("errorDeleteLevel"))}}function bo(e,t=""){let n=r=>d.appData.ui?.[d.currentLang]?.[r]||`[${r}]`,a="";switch(e){case"searching":a='<div class="loader"></div>';break;case"no-results":let r='<svg class="w-16 h-16 text-secondary opacity-50 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>',o=`${n("noResults")} "<b class="text-accent-teal">${t}</b>"`,s=n("noResultsSubtitle");a=`
                ${r}
                <h3 class="text-xl font-semibold text-primary">${o}</h3>
                <p class="text-secondary text-base mt-1 max-w-md">${s}</p>
            `;break;case"error":let i='<svg class="w-16 h-16 text-accent-red opacity-60 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>',l=n("searchErrorTitle"),p=n("searchError");a=`
                ${i}
                <h3 class="text-xl font-semibold text-primary">${l}</h3>
                <p class="text-secondary text-base mt-1 max-w-md">${p}</p>
                <button data-action="retry-search" data-query="${t}">${n("retryButton")}</button>
            `;break;case"prompt":default:let m='<svg class="w-16 h-16 text-secondary opacity-50 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>',f=n("dictionarySubtitle"),h=`<div class="search-placeholder-notice">${n("dictionaryNotice")}</div>`;a=`
                ${m}
                <h3 class="text-xl font-semibold text-primary">${f}</h3>
                ${h}
            `;break}return a}function de(e){let t=document.getElementById(e);if(!t)return;let n=(o,s={})=>{let i=d.appData.ui?.[d.currentLang]?.[o]||`[${o}]`;for(let[l,p]of Object.entries(s))i=i.replace(`{${l}}`,p);return i},a=n("errorContentNotAvailableTitle"),r=n("errorContentNotAvailableBody",{tabName:e,levelName:d.currentLevel.toUpperCase()});t.innerHTML=`
        <div class="p-6 text-center text-secondary content-anim-fade-in">
            <h3 class="font-semibold text-lg text-primary mb-2">${a}</h3>
            <p>${r}</p>
        </div>
    `}function Et(e,t,n,a){let o=document.getElementById("accordion-template").content.cloneNode(!0),s=o.querySelector(".search-wrapper"),i=o.querySelector(".accordion-button"),l=o.querySelector(".accordion-title"),p=o.querySelector(".accordion-content");return s.dataset.search=n,i.dataset.sectionTitleKey=a,i.dataset.action="toggle-accordion",l.textContent=e,p.appendChild(t),o}function kn(e){let t=document.createElement("div");return t.className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",e.forEach(n=>{let a=n.Kanji||n.Reading||Object.values(n)[0],r="";n.Reading&&a!==n.Reading&&(r=n.Reading);let o="";d.currentLang==="vi"&&n.vi?o=`<span style="color: var(--accent-yellow)">${n.vi}</span>`:d.currentLang==="en"&&(n.Number||n.en)&&(o=`<span style="color: var(--accent-yellow)">${n.Number||n.en}</span>`);let s=K([a,r,n.vi,n.en,n.Number]),i=document.createElement("div");i.className="cell-bg rounded-lg p-3 flex flex-col justify-center text-center h-24",i.dataset.searchItem=s,i.innerHTML=`
            <div class="font-bold text-primary text-base sm:text-lg noto-sans">${a}</div>
            ${r?`<div class="text-secondary text-xs sm:text-sm leading-relaxed mt-1">${r}</div>`:""}
            <div class="text-secondary text-xs sm:text-sm leading-relaxed mt-1">${o}</div>
        `,t.appendChild(i)}),t}var Eo=(e,t,n)=>{let r=document.getElementById("card-template").content.cloneNode(!0),o=r.querySelector(".relative"),s=r.querySelector(".learn-toggle"),i=r.querySelector(".card-face-front"),l=r.querySelector(".card-face-back");if(t==="kanji"){let v=document.createElement("div");v.className="details-toggle",v.dataset.action="show-kanji-details",v.dataset.id=e.id,v.innerHTML='<svg class="h-4 w-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512" fill="currentColor"><path d="M48 80a48 48 0 1 1 96 0A48 48 0 1 1 48 80zM0 224c0-17.7 14.3-32 32-32l64 0c17.7 0 32 14.3 32 32l0 224 32 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 512c-17.7 0-32-14.3-32-32s14.3-32 32-32l32 0 0-192-32 0c-17.7 0-32-14.3-32-32z"/></svg>',o.prepend(v)}let p=d.progress[t]?.includes(e.id),m=e.meaning?.[d.currentLang]||e.meaning?.en||"",f=t==="kanji"?`<p class="text-4xl sm:text-6xl font-bold noto-sans">${e.kanji}</p>`:`<div class="text-center p-2"><p class="text-xl sm:text-2xl font-semibold noto-sans">${e.word}</p></div>`,h="";t==="kanji"?(h=`<div class="w-full text-center"><p class="font-bold text-xl mb-2">${m}</p><div class="text-sm opacity-80"><p>On: ${e.onyomi}</p><p>Kun: ${e.kunyomi||"\u2013"}</p></div></div>`,l.style.justifyContent="center"):(h=`<p class="text-lg sm:text-xl font-bold">${e.reading}</p><p class="text-sm">${m}</p>`,l.style.justifyContent="space-around");let g=K([e.kanji,e.word,e.onyomi,e.kunyomi,e.reading,e.meaning?.en,e.meaning?.vi]);return o.dataset.searchItem=g,o.dataset.itemId=e.id,s.classList.toggle("learned",p),s.dataset.category=t,s.dataset.id=e.id,i.innerHTML=f,l.innerHTML=h,l.style.background=n,r},wo=(e,t,n,a,r)=>{if(!t||t.length===0)return document.createDocumentFragment();let o=document.createElement("div");o.className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4";let s=document.createDocumentFragment();t.forEach(p=>s.appendChild(Eo(p,n,a))),o.appendChild(s);let i=document.createElement("div");i.className="p-4 sm:p-5 sm:pt-0",i.appendChild(o);let l=K([e,...t.flatMap(p=>[p.kanji,p.word,p.meaning?.en,p.meaning?.vi])]);return Et(e,i,l,r)},Dn=(e,t,n)=>{let a=document.createDocumentFragment();return e&&Object.entries(e).forEach(([r,o])=>{if(!o.items)return;let s=o.items,i=o[d.currentLang]||o.en||r,l=K([i,...s.flatMap(f=>f.isPlaceholder?[]:[f.kana,f.romaji])]),p=`<div class="kana-grid">${s.map(f=>{if(f.isPlaceholder)return"<div></div>";let g=f.kana&&f.kana.length>1?"kana-font-digraph":"kana-font";return`<div class="flex flex-col items-center justify-center p-2 rounded-xl h-20 sm:h-24 text-center cell-bg" data-search-item="${K([f.kana,f.romaji])}"><p class="noto-sans ${g}" style="color:${n};">${f.kana}</p><p class="text-xs sm:text-sm text-secondary">${f.romaji}</p></div>`}).join("")}</div>`,m=`<div class="search-wrapper glass-effect rounded-2xl p-4 sm:p-5 mb-6" data-search="${l}"><h3 class="text-lg sm:text-lg font-bold mb-4 flex items-center gap-2 text-primary" data-section-title-key="${r}"><span class="text-2xl">${t}</span> ${i}</h3>${p}</div>`;a.appendChild(document.createRange().createContextualFragment(m))}),a};function Lo(e,t,n,a,r,o){let i=document.getElementById("progress-item-template").content.cloneNode(!0),l=i.querySelector(".progress-item-wrapper"),p=i.querySelector(".progress-fill"),m=i.querySelector(".progress-percentage"),f=i.querySelector(".progress-title"),h=i.querySelector(".progress-stats"),g=a>0?n/a*100:0,E=2*Math.PI*22,w=E-g/100*E,y=t.match(/\s(.*?)$/),L=y?t.replace(y[0],""):t,C=y?y[1]:"";return l.dataset.tabName=e,l.dataset.sectionKey=o,l.dataset.action="jump-to-section",p.style.strokeDasharray=E,p.style.strokeDashoffset=w,p.style.stroke=`url(#${r}-gradient)`,m.textContent=`${Math.round(g)}%`,f.textContent=`${L} ${C}`,h.textContent=`${n} / ${a}`,i}function W(){let e=[c.progressOverview,c.progressTab];if(!d.appData.ui||!e.every(r=>r))return;let t='<svg width="0" height="0"><defs><linearGradient id="purple-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A78BFA" /><stop offset="100%" stop-color="#8B5CF6" /></linearGradient><linearGradient id="green-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#4ADE80" /><stop offset="100%" stop-color="#22C55E" /></linearGradient></defs></svg>',n={kanji:"purple",vocab:"green"},a=document.createDocumentFragment();for(let[r,o]of Object.entries(n))if(d.appData[r])for(let s in d.appData[r]){let i=d.appData[r][s];if(!i.items||i.items.length===0)continue;let l=i.items.length,p=d.progress[r]?.filter(f=>i.items.some(h=>h.id===f)).length||0,m=Lo(r,i[d.currentLang]||i.en,p,l,o,s);a.appendChild(m)}e.forEach(r=>{if(!r)return;r.innerHTML="";let o=document.createElement("div");if(o.className="space-y-4",o.id=`progress-wrapper-${r.id}`,o.appendChild(a.cloneNode(!0)),r.id==="progress-overview"){let s=document.createElement("h2");s.className="text-xl font-bold mb-5",s.dataset.langKey="progressOverview",s.textContent=d.appData.ui[d.currentLang]?.progressOverview||"Progress Overview",r.innerHTML=t,r.appendChild(s),r.appendChild(o)}else r.innerHTML=t,r.appendChild(o)})}function pe(e){let t=e.querySelector("button.active"),n=e.querySelector(".lang-switch-pill");if(!t||!n)return;let a=t.offsetWidth,r=t.offsetLeft;requestAnimationFrame(()=>{n.style.width=`${a}px`,n.style.transform=`translateX(${r}px)`})}function Bn(){let e=document.documentElement.classList.contains("dark-mode");document.querySelectorAll(".theme-switch input").forEach(t=>t.checked=e)}function me(e){let t=c.pinToggle;if(!t)return;let n='<svg height="24" width="24" viewBox="0 0 519.657 1024"><path d="M196.032 704l64 320 64-320c-20.125 2-41.344 3.188-62.281 3.188C239.22 707.188 217.47 706.312 196.032 704zM450.032 404.688c-16.188-15.625-40.312-44.375-62-84.688v-64c7.562-12.406 12.25-39.438 23.375-51.969 15.25-13.375 24-28.594 24-44.875 0-53.094-61.062-95.156-175.375-95.156-114.25 0-182.469 42.062-182.469 95.094 0 16 8.469 31.062 23.375 44.312 13.438 14.844 22.719 38 31.094 52.594v64c-32.375 62.656-82 96.188-82 96.188h0.656C18.749 437.876 0 464.126 0 492.344 0.063 566.625 101.063 640.062 260.032 640c159 0.062 259.625-73.375 259.625-147.656C519.657 458.875 493.407 428.219 450.032 404.688z"/></svg>';t.innerHTML=n;let a=t.querySelector("svg"),r=e&&e===d.pinnedTab;t.classList.toggle("pinned",r),a.style.fill=r?"var(--pin-color)":"var(--pin-unpinned)",a.style.width="1.25em",a.style.height="1.25em"}function fe(){document.querySelectorAll(".sidebar-pin-btn").forEach(e=>{let t=e.dataset.tabName,n=e.closest(".nav-item-wrapper"),a=t===d.pinnedTab;n&&n.classList.toggle("is-pinned",a),e.classList.toggle("is-pinned",a),e.querySelector("svg")||(e.innerHTML='<svg viewBox="0 0 519.657 1024"><path d="M196.032 704l64 320 64-320c-20.125 2-41.344 3.188-62.281 3.188C239.22 707.188 217.47 706.312 196.032 704zM450.032 404.688c-16.188-15.625-40.312-44.375-62-84.688v-64c7.562-12.406 12.25-39.438 23.375-51.969 15.25-13.375 24-28.594 24-44.875 0-53.094-61.062-95.156-175.375-95.156-114.25 0-182.469 42.062-182.469 95.094 0 16 8.469 31.062 23.375 44.312 13.438 14.844 22.719 38 31.094 52.594v64c-32.375 62.656-82 96.188-82 96.188h0.656C18.749 437.876 0 464.126 0 492.344 0.063 566.625 101.063 640.062 260.032 640c159 0.062 259.625-73.375 259.625-147.656C519.657 458.875 493.407 428.219 450.032 404.688z"/></svg>');let r=e.querySelector("svg");r.style.fill=a?"var(--pin-pinned-bg)":"var(--text-secondary)"})}function q(){c.sidebar?.classList.remove("open"),c.overlay?.classList.remove("active"),document.body.classList.remove("sidebar-open")}async function Mn(e,t,n,a){let r=document.getElementById(e);if(!r)return;if(r.innerHTML="",!t){de(e);return}let o=document.createDocumentFragment();for(let i in t){let l=t[i];if(!l.items)continue;let p=l[d.currentLang]||l.en;o.appendChild(wo(p,l.items,n,a,i))}let s=document.createElement("div");s.className="space-y-4",s.appendChild(o),r.appendChild(s),Z(n)}function Oe(e){if(!d.appData.kanji)return null;for(let t in d.appData.kanji){let n=d.appData.kanji[t].items.find(a=>a.kanji===e);if(n)return n}return null}function re(e,t={},n=!1){if(!c.externalSearchTab)return;let{results:a,query:r}=t,o=(l,p)=>d.appData.ui?.[d.currentLang]?.[l]||p,s=c.externalSearchTab.querySelector(".results-container");s||(s=document.createElement("div"),s.className="results-container",c.externalSearchTab.appendChild(s));let i=c.externalSearchTab.querySelector(".placeholder-container");if(i||(i=document.createElement("div"),i.className="placeholder-container search-placeholder-wrapper",i.innerHTML='<div class="search-placeholder-box"></div>',c.externalSearchTab.appendChild(i)),e==="results"){i.style.display="none",s.style.display="block",s.innerHTML="";let l=document.createDocumentFragment(),p=a?.words?.length>0,m=a?.kanji?.length>0;if(p){let h=document.createElement("div");h.className="search-wrapper glass-effect rounded-2xl p-4 sm:p-5 mb-6";let g=document.createElement("h3");g.className="text-lg sm:text-lg font-bold mb-4 text-primary",g.textContent=o("vocabResults","Vocabulary Results"),h.appendChild(g);let v=document.createElement("div");v.className="dict-grid",a.words.forEach(E=>{if(!E?.reading||!E?.senses)return;let w=/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;if(d.currentLang==="vi"&&!w.test(E.reading.kanji))E.senses.forEach(L=>{let C=L.glosses?.[0]||"";if(!C)return;let D=document.createElement("div");D.className="dict-card";let B=L.reading||"",M=C.split("").map(x=>/[\u4e00-\u9faf]/.test(x)&&Oe(x)?`<span class="hover:text-accent-teal cursor-pointer transition-colors" data-action="show-kanji-details" data-id="${Oe(x).id}">${x}</span>`:`<span>${x}</span>`).join("");D.innerHTML=`<div class="dict-vocab-header"><h4 class="dict-vocab-term">${M}</h4>${B?`<span class="dict-vocab-reading">(${B})</span>`:""}</div><div class="dict-vocab-definitions"><p>${E.reading.kanji}</p></div>`,v.appendChild(D)});else{let L=document.createElement("div");L.className="dict-card";let C=E.reading.kanji||E.reading.kana||"",D=E.reading.kana&&E.reading.kana!==C?`(${E.reading.kana})`:"";if(!C)return;let M=`<div class="dict-vocab-header"><h4 class="dict-vocab-term">${C.split("").map(A=>/[\u4e00-\u9faf]/.test(A)&&Oe(A)?`<span class="hover:text-accent-teal cursor-pointer transition-colors" data-action="show-kanji-details" data-id="${Oe(A).id}">${A}</span>`:`<span>${A}</span>`).join("")}</h4><span class="dict-vocab-reading">${D}</span></div>`,x=(E.senses??[]).map(A=>{let T=A.glosses?.join("; ")??"",J=[...new Set((A.pos??[]).map(j=>typeof j=="object"?Object.keys(j)[0]:j))],z=J.length>0?`<span class="dict-vocab-pos">[${J.join(", ")}]</span>`:"";return`<p>${T} ${z}</p>`}).join("");L.innerHTML=`${M}<div class="dict-vocab-definitions">${x}</div>`,v.appendChild(L)}}),h.appendChild(v),l.appendChild(h)}if(m){let h=document.createElement("div");h.className="search-wrapper glass-effect rounded-2xl p-4 sm:p-5 mb-6";let g=document.createElement("h3");g.className="text-lg sm:text-lg font-bold mb-4 text-primary",g.textContent=o("kanjiResults","Kanji Results"),h.appendChild(g);let v=document.createElement("div");v.className="dict-grid",a.kanji.forEach(E=>{if(!E?.literal)return;let w=document.createElement("div");w.className="dict-card";let y=E.onyomi?.join(", ")||"\u2013",L=E.kunyomi?.join(", ")||"\u2013",C=E.meanings?.join("; ")||o("noDefinition","No definition found.");w.innerHTML=`<div class="dict-kanji-header"><h4 class="dict-kanji-char">${E.literal}</h4><div class="dict-kanji-readings"><p><span class="reading-label">${o("onyomi","On'yomi:")}</span> ${y}</p><p><span class="reading-label">${o("kunyomi","Kun'yomi:")}</span> ${L}</p></div></div><div class="dict-kanji-meanings">${C}</div>`,v.appendChild(w)}),h.appendChild(v),l.appendChild(h)}let f=document.createElement("div");n||(f.className="anim-fade-in"),f.appendChild(l),s.appendChild(f)}else{s.style.display="none",i.style.display="flex";let l=i.querySelector(".search-placeholder-box");l&&(l.innerHTML=bo(e,r),n||(l.classList.remove("anim-fade-in"),l.offsetWidth,l.classList.add("anim-fade-in")))}}function In(e){if(!e)return{};let t=JSON.parse(JSON.stringify(e)),n={gojuon:["a","i","u","e","o","ka","ki","ku","ke","ko","sa","shi","su","se","so","ta","chi","tsu","te","to","na","ni","nu","ne","no","ha","hi","fu","he","ho","ma","mi","mu","me","mo","ya",null,"yu",null,"yo","ra","ri","ru","re","ro","wa",null,null,null,"wo","n",null,null,null,null],dakuten:["ga","gi","gu","ge","go","za","ji","zu","ze","zo","da","di","dzu","de","do","ba","bi","bu","be","bo"],handakuten:["pa","pi","pu","pe","po"],youon:["kya","kyu","kyo","sha","shu","sho","cha","chu","cho","nya","nyu","nyo","hya","hyu","hyo","mya","myu","myo","rya","ryu","ryo","gya","gyu","gyo","ja","ju","jo","bya","byu","byo","pya","pyu","pyo"]};for(let a in t){let r=t[a];if(!r?.items?.length)continue;let o=r.items,s=new Set(o.map(p=>p.romaji)),i=p=>o.find(m=>m.romaji===p)||{isPlaceholder:!0},l=null;s.has("kya")||s.has("gya")?l=n.youon:s.has("ga")||s.has("za")?l=n.dakuten:s.has("pa")?l=n.handakuten:s.has("a")&&(l=n.gojuon),l&&(r.items=l.map(p=>p?i(p):{isPlaceholder:!0}))}return t}async function Be(e){let n=await(await k).get("levels",e),a=n?Object.keys(n):["kanji","vocab","grammar","keyPoints","hiragana","katakana"];document.querySelectorAll(".nav-item-wrapper").forEach(i=>{let l=i.querySelector("[data-tab-name]")?.dataset.tabName;l&&!["progress","external-search"].includes(l)&&(i.style.display=a.includes(l)?"":"none")});let r=["n5","n4"].includes(e),o=document.querySelector('[data-tab-name="hiragana"]')?.parentElement,s=document.querySelector('[data-tab-name="katakana"]')?.parentElement;o&&(o.style.display=r?"":"none"),s&&(s.style.display=r?"":"none")}async function vt(e=null){let t=async(r,o)=>{try{d.appData[o]?r():await(await k).get("levels",d.currentLevel)&&de(o)}catch(s){console.error("Render error in tab",o,":",s),de(o)}},n=e?[e]:Object.keys(u.appData).filter(r=>!["ui","progress","external-search"].includes(r)),a={hiragana:()=>t(()=>{c.hiraganaTab&&d.appData.hiragana&&(c.hiraganaTab.innerHTML="",c.hiraganaTab.appendChild(Dn(In(d.appData.hiragana),"\u{1F338}","var(--accent-pink)")),Z("hiragana"))},"hiragana"),katakana:()=>t(()=>{c.katakanaTab&&d.appData.katakana&&(c.katakanaTab.innerHTML="",c.katakanaTab.appendChild(Dn(In(d.appData.katakana),"\u{1F916}","var(--accent-blue)")),Z("katakana"))},"katakana"),keyPoints:()=>t(()=>{if(!c.keyPointsTab||!d.appData.keyPoints)return;c.keyPointsTab.innerHTML="";let r=document.createDocumentFragment();for(let s in d.appData.keyPoints){let i=d.appData.keyPoints[s],l=i[d.currentLang]||i.en,p;if(i.type==="table"?p=kn(i.content):i.type==="table-grid"&&(p=document.createElement("div"),p.className="space-y-6",i.content.forEach(m=>{let f=m.title[d.currentLang]||m.title.en,h=kn(m.data);p.innerHTML+=`<div><h4 class="font-semibold text-md mb-3 text-primary">${f}</h4></div>`,p.lastChild.appendChild(h)})),p){let m=document.createElement("div");m.className="p-4 sm:p-5 sm:pt-0",m.appendChild(p);let f=K([l,JSON.stringify(i.content)]);r.appendChild(Et(l,m,f,s))}}let o=document.createElement("div");o.className="space-y-4",o.appendChild(r),c.keyPointsTab.appendChild(o),Z("keyPoints")},"keyPoints"),grammar:()=>t(()=>{if(!c.grammarTab||!d.appData.grammar)return;c.grammarTab.innerHTML="";let r=document.createDocumentFragment();for(let s in d.appData.grammar){let i=d.appData.grammar[s],l=i[d.currentLang]||i.en,p=document.createElement("div");p.className="grammar-grid",i.items.forEach(h=>{let g=h[d.currentLang]||h.en,v=K([g.title,g.content]),E=/(<br>)?<b>(Example|Ví dụ).*?<\/b>/i,w=g.content.match(E),y=g.content,L="";w?.index&&(y=g.content.substring(0,w.index),L=g.content.substring(w.index).replace(/^<br>/,""));let C=document.createElement("div");C.className="grammar-card cell-bg rounded-lg",C.dataset.searchItem=v,C.innerHTML=`<h4 class="font-semibold text-primary noto-sans">${g.title}</h4><div class="grammar-description mt-2 text-secondary leading-relaxed text-sm">${y}</div>${L?`<div class="grammar-example mt-3 text-sm">${L}</div>`:""}`,p.appendChild(C)});let m=document.createElement("div");m.className="p-4 sm:p-5 sm:pt-0",m.appendChild(p);let f=K([l,...i.items.flatMap(h=>[h.en?.title,h.en?.content,h.vi?.title,h.vi?.content])]);r.appendChild(Et(l,m,f,s))}let o=document.createElement("div");o.className="space-y-4",o.appendChild(r),c.grammarTab.appendChild(o),Z("grammar")},"grammar"),kanji:()=>t(()=>Mn("kanji",d.appData.kanji,"kanji","linear-gradient(135deg, var(--accent-purple), #A78BFA)"),"kanji"),vocab:()=>t(()=>Mn("vocab",d.appData.vocab,"vocab","linear-gradient(135deg, var(--accent-green), #4ADE80)"),"vocab")};for(let r of n)a[r]&&await a[r]()}function he(e=[],t=[]){let n=document.getElementById("level-switcher-sidebar");if(!n)return;d.allAvailableLevels=Array.from(new Set([...e,...t]));let a=document.createDocumentFragment();d.allAvailableLevels.forEach(r=>{let o=r===I.defaultLevel,i=t.includes(r)&&!o?`<button class="delete-level-btn" data-action="delete-level" data-level-name="${r}" title="Delete level ${r.toUpperCase()}"><svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`:"",l=document.createElement("div");l.className="level-switch-item-wrapper",l.innerHTML=`<button data-action="set-level" data-level-name="${r}" class="level-switch-button">${r.toUpperCase()}</button>${i}`,a.appendChild(l)}),n.innerHTML="",n.appendChild(a)}function jn(){let e=document.querySelector("#level-switcher-sidebar .level-switch-button.active");e&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})},100)}function bt(e){let t=(o,s="")=>d.appData.ui?.[d.currentLang]?.[o]||s,n=e==="external-search",a=n?t("dictionaryPrompt","Search for words..."):t("searchPlaceholder","Search anything..."),r=n?t("dictionaryPrompt","Search for words..."):t("searchTabPlaceholder","Search in this tab...");c.searchInput&&(c.searchInput.placeholder=a),c.mobileSearchInput&&(c.mobileSearchInput.placeholder=r)}function Nn({title:e,message:t,buttons:n,onOpen:a,onClose:r}){return new Promise(o=>{if(!c.customDialogContainer)return;let i=document.getElementById("custom-dialog-template").content.cloneNode(!0),l=c.customDialogContainer.querySelector(".modal-content-container");if(!l)return;l.innerHTML="",l.appendChild(i);let p=l.querySelector("#custom-dialog-title"),m=l.querySelector("#custom-dialog-message"),f=l.querySelector("#custom-dialog-actions"),h=l.querySelector("#custom-dialog-close-btn");p.textContent=e,m.textContent=t,f.innerHTML="";let g,v=w=>()=>{g(),Ao(),o(w==="confirm"?"confirm":"cancel"),r&&r(w)};n.forEach(w=>{let y=document.createElement("button");y.textContent=w.text,y.className=`modal-button ${w.className||"modal-button-secondary"}`,y.dataset.actionType=w.action,y.addEventListener("click",v(w.action)),f.appendChild(y)}),h.addEventListener("click",v("cancel"));let E=w=>{(w.target===c.customDialogBackdrop||w.target===c.customDialogWrapper)&&v("cancel")()};c.customDialogBackdrop.addEventListener("click",E),c.customDialogWrapper.addEventListener("click",E),g=()=>{c.customDialogBackdrop.removeEventListener("click",E),c.customDialogWrapper.removeEventListener("click",E),h.removeEventListener("click",v("cancel")),n.forEach(w=>{let y=f.querySelector(`[data-action-type="${w.action}"]`);y&&y.removeEventListener("click",v(w.action))})},document.body.classList.add("body-no-scroll"),c.customDialogContainer.classList.remove("modal-hidden"),c.customDialogBackdrop.classList.add("active"),c.customDialogWrapper.classList.add("active"),a&&a()})}function F(e,t){return Nn({title:e,message:t,buttons:[{text:(a=>d.appData.ui?.[d.currentLang]?.[a]||`[${a}]`)("okButton","OK"),className:"modal-button-primary",action:"confirm"}]}).then(()=>{})}function je(e,t){let n=a=>d.appData.ui?.[d.currentLang]?.[a]||`[${a}]`;return Nn({title:e,message:t,buttons:[{text:n("cancelButton","Cancel"),className:"modal-button-secondary",action:"cancel"},{text:n("confirmButton","Confirm"),className:"modal-button-primary",action:"confirm"}]}).then(a=>a==="confirm")}function Ao(){if(!c.customDialogContainer||c.customDialogContainer.classList.contains("modal-hidden"))return;let e=c.customDialogBackdrop,t=c.customDialogWrapper,n=c.customDialogContainer;document.body.classList.remove("body-no-scroll"),e&&e.classList.remove("active"),t&&t.classList.remove("active");let a=r=>{if(r.target!==t)return;n.classList.add("modal-hidden");let o=n.querySelector(".modal-content-container");o&&(o.innerHTML=""),t.removeEventListener("transitionend",a)};if(t&&getComputedStyle(t).transitionDuration!=="0s")t.addEventListener("transitionend",a,{once:!0});else{n.classList.add("modal-hidden");let r=n.querySelector(".modal-content-container");r&&(r.innerHTML="")}}var k=Bt("HandbookDB",3,{upgrade(e,t){t<1&&(e.createObjectStore("levels"),e.createObjectStore("progress"),e.createObjectStore("settings")),t<2&&e.createObjectStore("dictionary_cache"),t<3&&e.createObjectStore("notes")}});async function On(){try{let e=await k,[t,n,a]=await Promise.all([e.get("settings","language"),e.get("settings","currentLevel"),e.get("settings","levelSettings")]);d.currentLang=t||"en",d.currentLevel=n||I.defaultLevel;let r=a?.[d.currentLevel];d.pinnedTab=r?.pinnedTab||null,d.progress=await e.get("progress",d.currentLevel)||{kanji:[],vocab:[]}}catch(e){console.error("Error loading state from IndexedDB:",e),d.currentLang="en",d.currentLevel=I.defaultLevel,d.progress={kanji:[],vocab:[]}}}async function Tn(){try{await(await k).put("progress",d.progress,d.currentLevel),W()}catch(e){console.error("Error saving progress to IndexedDB:",e)}}async function Q(e,t){try{await(await k).put("settings",t,e)}catch(n){console.error(`Error saving setting '${e}' to IndexedDB:`,n)}}async function ge(e,t){if(!d.appData[t])try{let n=await fetch(`${I.dataPath}/${e}/${t}.json`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);let a=await n.json();d.appData[t]=a}catch(n){console.error(`Error loading data for tab ${t}:`,n);let a=document.getElementById(t);if(a){let o=((s,i={})=>{let l=d.appData.ui?.[d.currentLang]?.[s]||d.appData.ui?.en?.[s]||`[${s}]`;for(let[p,m]of Object.entries(i))l=l.replace(`{${p}}`,m);return l})("errorFailedToLoadContent",{tabId:t});a.innerHTML=`<p class="p-4 text-center text-red-400">${o}</p>`}throw n}}async function Ne(e){let t=fetch(`./data/${I.defaultLevel}/ui.json`).then(r=>{if(!r.ok)throw new Error(`Failed to fetch UI data: ${r.status}`);return r.json()}).catch(r=>(console.error("Fatal: Could not load the global ui.json file.",r),{})),a=await(await k).get("levels",e);a?d.appData=a:d.appData={},d.appData.ui=await t}async function $n(e,t,n){try{let a=await k,r=`${e}-${t}`,o={content:n,lastModified:new Date().toISOString()};await a.put("notes",o,r)}catch(a){console.error(`Error saving note for ${e}-${t}:`,a)}}async function wt(e,t){try{let n=await k,a=`${e}-${t}`;return await n.get("notes",a)||null}catch(n){return console.error(`Error loading note for ${e}-${t}:`,n),null}}async function Sn(e){try{let n=(await k).transaction("notes","readwrite"),r=(await n.store.getAllKeys()).filter(o=>o.startsWith(`${e}-`));await Promise.all(r.map(o=>n.store.delete(o))),await n.done}catch(t){console.error(`Error deleting notes for level ${e}:`,t)}}var S=(e,t={})=>{let n=d.appData.ui?.[d.currentLang]?.[e]||d.appData.ui?.en?.[e]||`[${e}]`;e==="lastSavedOn"&&!d.appData.ui?.[d.currentLang]?.[e]&&(n="Last saved: {date}");for(let[a,r]of Object.entries(t))n=n.replace(`{${a}}`,r);return n};async function Co(){let e=["kanji","vocab"],t=[];for(let n of e)d.appData[n]||await(await k).get("levels",d.currentLevel)||t.push(ge(d.currentLevel,n));if(t.length>0)try{await Promise.all(t)}catch(n){console.error("Failed to load required data for progress dashboard:",n)}}async function Lt(e,...t){await ue(e,...t),e==="progress"&&W();let n=!["progress","external-search"].includes(e),a=document.querySelectorAll(".notes-header-btn");if(a.forEach(r=>{r.style.display=n?"flex":"none",r.classList.remove("has-note")}),n){let r=await wt(d.currentLevel,e),o=r&&typeof r=="object"?!!r.content?.trim():!!r?.trim();a.forEach(s=>{s.classList.toggle("has-note",o)})}}function xo(){return'<label class="theme-switch"><input type="checkbox" aria-label="Theme toggle"><span class="slider"></span></label>'}function _n(){return'<div class="lang-switch-pill"></div><button data-lang="en">EN</button><button data-lang="vi">VI</button>'}function To(e){e&&(e.level!==d.currentLevel?le(e.level,!0):Lt(e.tabName,null,!1,!0))}function gs(e){let t=null;for(let h in d.appData.kanji){let g=d.appData.kanji[h].items.find(v=>v.id===e);if(g){t=g;break}}if(!t){console.error("Kanji item not found:",e);return}let n=document.getElementById("kanji-modal-template");if(!n){console.error("Kanji modal template not found in HTML.");return}let a=n.content.cloneNode(!0);a.querySelector('[data-template-id="kanji-char"]').textContent=t.kanji,a.querySelector('[data-template-id="kanji-meaning"]').textContent=t.meaning?.[d.currentLang]||t.meaning?.en||"";let r=a.querySelector('[data-template-id="examples-section"]');if(t.examples&&t.examples.length>0){let h=a.querySelector('[data-template-id="examples-list"]');r.style.display="block",r.querySelector("[data-lang-key]").textContent=S("modalExamples"),t.examples.forEach(g=>{let v=document.createElement("li");v.className="flex justify-between items-baseline",v.innerHTML=`
                <span class="font-semibold noto-sans with-furigana"><ruby>${g.word}<rt>${g.reading}</rt></ruby></span>
                <span class="kanji-modal-translation">${g.meaning[d.currentLang]||g.meaning.en}</span>`,h.appendChild(v)})}let o=a.querySelector('[data-template-id="sentence-section"]'),s=t.sentence?.jp_tokens,i=t.sentence?.jp;if(s||i){o.style.display="block";let h="";s?h=s.map(g=>g.r?`<ruby>${g.w}<rt>${g.r}</rt></ruby>`:g.w).join(""):h=i,a.querySelector('[data-template-id="sentence-jp"]').innerHTML=h,a.querySelector('[data-template-id="sentence-translation"]').textContent=t.sentence?.[d.currentLang]||t.sentence?.en||""}let l=t.mnemonic?.[d.currentLang]||t.mnemonic?.en||"",p=t.radical?.[d.currentLang]||t.radical?.en||"";if(l||p){let h=a.querySelector('[data-template-id="info-section"]');if(h.style.display="block",h.querySelector("[data-lang-key]").textContent=S("modalInfo"),p){let g=a.querySelector('[data-template-id="radical-section"]');g.style.display="block",g.querySelector("[data-lang-key]").textContent=S("modalRadical"),g.querySelector('[data-template-id="radical-text"]').textContent=p}if(l){let g=a.querySelector('[data-template-id="mnemonic-section"]');g.style.display="block",g.querySelector("[data-lang-key]").textContent=S("modalMnemonic"),g.querySelector('[data-template-id="mnemonic-text"]').textContent=l}}c.kanjiModalContentContainer.innerHTML="",c.kanjiModalContentContainer.appendChild(a);let m=c.kanjiModalContentContainer.querySelector(".kanji-modal-scroll-content"),f=c.kanjiModalContentContainer.querySelector(".fade-indicator");if(m&&f){let h=()=>{let g=m.scrollHeight-m.scrollTop<=m.clientHeight+5;f.style.opacity=g?"0":"1"};m.addEventListener("scroll",h),setTimeout(h,50)}document.body.classList.add("body-no-scroll"),c.kanjiDetailModal.classList.remove("modal-hidden"),c.kanjiModalBackdrop.classList.add("active"),c.kanjiDetailModal.querySelector(".modal-wrapper").classList.add("active")}function Rn(){document.body.classList.remove("body-no-scroll"),c.kanjiModalBackdrop.classList.remove("active"),c.kanjiDetailModal.querySelector(".modal-wrapper").classList.remove("active"),setTimeout(()=>{c.kanjiDetailModal.classList.add("modal-hidden")},400)}async function vs(){let e=d.activeTab;if(!e||["progress","external-search"].includes(e))return;let t=document.querySelector(`.nav-item[data-tab-name="${e}"] span`),n=t?t.textContent.trim():e;c.notesModalTitle.textContent=S("notesFor",{tabName:n}),c.notesSaveBtn.textContent=S("saveNotes"),c.notesTextarea.placeholder=S("notesPlaceholder");let a=await wt(d.currentLevel,e),r=document.getElementById("note-info-display"),o="";if(a&&typeof a=="object"&&a.lastModified){o=a.content||"";let s=new Date(a.lastModified);if(isNaN(s.getTime()))r.textContent="";else{let i=s.toISOString().split("T")[0];r.textContent=S("lastSavedOn",{date:i})}}else typeof a=="string"?(o=a,r.textContent=""):(o="",r.textContent="");c.notesTextarea.value=o,d.notes.originalContent=o,document.body.classList.add("body-no-scroll"),c.notesModal.classList.remove("modal-hidden"),c.notesModalBackdrop.classList.add("active"),c.notesModalWrapper.classList.add("active"),c.notesTextarea.focus()}function $e(){let e=c.notesTextarea.value,t=d.notes.originalContent,n=()=>{document.body.classList.remove("body-no-scroll"),c.notesModalBackdrop.classList.remove("active"),c.notesModalWrapper.classList.remove("active"),setTimeout(()=>c.notesModal.classList.add("modal-hidden"),300),d.notes.originalContent=""};e!==t?je(S("unsavedChangesTitle","Unsaved Changes"),S("unsavedChangesBody","You have unsaved changes. Are you sure you want to close without saving?")).then(a=>{a&&n()}):n()}async function Pn(){let e=c.notesTextarea.value;await $n(d.currentLevel,d.activeTab,e),d.notes.originalContent=e,document.querySelectorAll(".notes-header-btn").forEach(n=>{n.classList.toggle("has-note",!!e.trim())}),c.notesStatus.style.opacity="1",setTimeout(()=>{$e(),setTimeout(()=>{c.notesStatus.style.opacity="0"},500)},1e3)}function So(){let e=document.documentElement.classList.toggle("dark-mode"),t=e?"dark":"light";c.themeEmoji&&(c.themeEmoji.textContent=e?"\u{1F319}":"\u2600\uFE0F");let n=document.querySelector("#sidebar-controls .theme-switch input");n&&(n.checked=e),Q("theme",t);try{localStorage.setItem("theme",t)}catch(a){console.warn("Could not save theme to localStorage.",a)}}function ko(){document.body.addEventListener("click",t=>{let n=t.target.closest("[data-action]");if(!n)return;let a=n.dataset.action,r={"change-tab":()=>Lt(n.dataset.tabName,n),"toggle-sidebar":()=>{c.sidebar?.classList.add("open"),c.overlay?.classList.add("active"),document.body.classList.add("sidebar-open")},"toggle-theme":()=>So(),"toggle-pin":()=>Ln(),"toggle-sidebar-pin":()=>An(t,n.dataset.tabName),"flip-card":()=>{t.target.closest('[data-action="show-kanji-details"]')||n.closest(".card").classList.toggle("is-flipped")},"toggle-learned":()=>En(n.dataset.category,n.dataset.id,n),"jump-to-section":()=>Cn(n.dataset.tabName,n.dataset.sectionKey),"delete-level":()=>xn(n.dataset.levelName),"set-level":()=>le(n.dataset.levelName),"toggle-accordion":()=>n.classList.toggle("open")};r[a]&&(t.preventDefault(),r[a]()),a==="open-notes"&&(t.preventDefault(),Promise.resolve().then(()=>require_main()).then(o=>o.openNotesModal())),a==="show-kanji-details"&&(t.preventDefault(),Promise.resolve().then(()=>require_main()).then(o=>o.openKanjiDetailModal(n.dataset.id))),a==="close-kanji-modal"&&(t.preventDefault(),Promise.resolve().then(()=>require_main()).then(o=>o.closeKanjiDetailModal()))}),c.overlay?.addEventListener("click",q),c.searchInput?.addEventListener("input",Ie),c.mobileSearchInput?.addEventListener("input",Ie),c.closeSidebarBtn?.addEventListener("click",q);let e=ae(()=>{document.querySelectorAll(".lang-switch").forEach(pe);let t=window.innerWidth<=768;if(c.pinToggle&&(c.pinToggle.style.display=t?"block":"none",t)){let n=document.querySelector(".tab-content.active");n&&me(n.id)}},100);window.addEventListener("resize",e),c.kanjiDetailModal.addEventListener("click",t=>{t.target===c.kanjiModalBackdrop&&Rn()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&(c.kanjiDetailModal.classList.contains("modal-hidden")?c.notesModal.classList.contains("modal-hidden")||$e():Rn())}),c.closeNotesModalBtn?.addEventListener("click",$e),c.notesSaveBtn?.addEventListener("click",Pn),c.notesModalWrapper?.addEventListener("click",t=>{t.target===c.notesModalWrapper&&$e()}),c.notesTextarea?.addEventListener("keydown",t=>{t.key==="s"&&(t.ctrlKey||t.metaKey)&&(t.preventDefault(),Pn())}),window.addEventListener("popstate",t=>{To(t.state)})}function Do(){if(!c.importModal)return;let e={},t=!1,n=()=>{c.importModal.querySelectorAll("[data-lang-key]").forEach(m=>m.textContent=S(m.dataset.langKey)),c.importModal.querySelectorAll("[data-lang-placeholder-key]").forEach(m=>m.placeholder=S(m.dataset.langPlaceholderKey))},a=()=>{document.body.classList.add("body-no-scroll"),q(),s(),n(),c.importModal.classList.remove("modal-hidden"),c.importModalBackdrop.classList.add("active"),c.modalWrapper.classList.add("active")},r=()=>{document.body.classList.remove("body-no-scroll"),c.importModalBackdrop.classList.remove("active"),c.modalWrapper.classList.remove("active"),setTimeout(()=>c.importModal.classList.add("modal-hidden"),300)},o=()=>{let m=c.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");t=!1,m?d.allAvailableLevels.includes(m)?c.levelNameError.textContent=S("errorLevelNameExists"):(c.levelNameError.textContent="",t=!0):c.levelNameError.textContent=S("errorLevelNameRequired");let f=Object.keys(e).length>0;c.importBtn.disabled=!t||!f},s=()=>{c.levelNameInput.value="",c.fileInput.value="",c.levelNameError.textContent="",e={},t=!1,c.fileImportArea.classList.remove("state-preview","drag-active"),c.fileImportArea.innerHTML='<svg class="upload-icon" viewBox="0 0 24 24"><path d="M3 15C3 17.8284 3 19.2426 3.87868 20.1213C4.75736 21 6.17157 21 9 21H15C17.8284 21 19.2426 21 20.1213 20.1213C21 19.2426 21 17.8284 21 15" fill="none" stroke="currentColor"/><path class="arrow" d="M12 16V3M12 3L16 7M12 3L8 7" stroke="currentColor"/></svg><p class="font-semibold text-primary" data-lang-key="dropZoneTitle"></p><p class="text-sm text-secondary" data-lang-key="dropZoneOrClick"></p>',c.fileImportArea.querySelectorAll("[data-lang-key]").forEach(m=>m.textContent=S(m.dataset.langKey)),o()},i=async m=>{let f=m?Array.from(m):[];e={},c.fileInput.value="",c.fileImportArea.classList.add("state-preview");let h=["grammar.csv","hiragana.csv","kanji.csv","katakana.csv","keyPoints.csv","vocab.csv"],g=f.filter(y=>h.includes(y.name));if(g.length===0){c.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${S("errorNoSupportedFiles")}</p>`,o(),setTimeout(s,2e3);return}let v=y=>{let L=y.replace(/\r/g,"").split(`
`).filter(B=>B.trim()!=="");if(L.length<2)return[];let C=B=>{let M=[],x="",A=!1;for(let T of B)T==='"'&&(x.length===0||!A)?A=!A:T===";"&&!A?(M.push(x),x=""):x+=T;return M.push(x),M.map(T=>T.startsWith('"')&&T.endsWith('"')?T.slice(1,-1):T)},D=C(L[0]).map(B=>B.trim());return L.slice(1).map(B=>{let M=C(B);return M.length!==D.length?(console.warn("Skipping malformed CSV line:",B),null):D.reduce((x,A,T)=>(x[A]=(M[T]||"").trim(),x),{})}).filter(Boolean)},E=(y,L)=>{let C=`user_created_${y}`,D={en:`User ${y.charAt(0).toUpperCase()+y.slice(1)}`,vi:`${y.charAt(0).toUpperCase()+y.slice(1)} ng\u01B0\u1EDDi d\xF9ng`},B=L.map((M,x)=>{let A={id:`${y}_user_${x}`};for(let T in M)if(Object.prototype.hasOwnProperty.call(M,T)){let J=M[T],z=T.match(/_(en|vi)$/);if(z){let j=T.replace(/_(en|vi)$/,""),At=z[1];A[j]||(A[j]={}),A[j][At]=J}else A[T]=J}return y==="kanji"&&(A.examples||(A.examples=[]),A.sentence||(A.sentence={})),A});return{[C]:{...D,items:B}}},w=g.map(y=>new Promise((L,C)=>{let D=new FileReader;D.onload=B=>{try{let M=B.target.result,x=y.name.replace(".csv",""),A=v(M);if(A.length===0){console.warn(`CSV file '${y.name}' is empty or invalid. Skipping.`),L(null);return}let T=E(x,A);L({name:x,data:T})}catch(M){console.error(`Error processing ${y.name}:`,M),C(`Error parsing ${y.name}`)}},D.onerror=()=>C(`Could not read ${y.name}`),D.readAsText(y)}));try{let y=(await Promise.all(w)).filter(Boolean);if(y.length===0){c.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${S("errorNoValidData")}</p>`,o(),setTimeout(s,2e3);return}y.forEach(C=>{e[C.name]=C.data});let L=`<div class="w-full"><p class="text-sm font-medium mb-2 text-primary">${S("filesToBeImported")}</p><div class="space-y-2">`;g.forEach(C=>{L+=`<div class="preview-item"><p class="font-medium text-primary text-sm">${C.name}</p><span class="text-xs font-mono bg-green-500/20 text-green-300 px-2 py-1 rounded-full">\u2713</span></div>`}),L+="</div></div>",c.fileImportArea.innerHTML=L}catch(y){c.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${y}</p>`,setTimeout(s,2e3)}o()},l=async()=>{let m=c.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");if(!(!t||Object.keys(e).length===0))try{c.importBtn.disabled=!0,c.importBtn.querySelector("span").textContent=S("importButtonProgress");let f=await k,h={en:{userCreated:"User Created"},vi:{userCreated:"Ng\u01B0\u1EDDi d\xF9ng t\u1EA1o"}};e.ui=h,await f.put("levels",e,m);let g=await fetch(`${I.dataPath}/levels.json`),v=g.ok?await g.json():{levels:[]},E=await f.getAllKeys("levels");he(v.levels,E),await le(m),F(S("successTitle","Success"),S("importSuccess",{levelName:m.toUpperCase()})),r()}catch(f){console.error("Failed to save imported level:",f),F(S("errorTitle","Error"),S("errorSaveImportedLevel","Error: Could not save the new level."))}finally{c.importBtn.disabled=!1,c.importBtn.querySelector("span").textContent=S("importButton")}},p=document.getElementById("sidebar-import-btn");p&&p.addEventListener("click",a),c.closeModalBtn?.addEventListener("click",r),c.modalWrapper?.addEventListener("click",m=>{m.target===c.modalWrapper&&r()}),c.levelNameInput?.addEventListener("input",o),c.importBtn?.addEventListener("click",l),c.fileImportArea?.addEventListener("click",()=>{c.fileImportArea.classList.contains("state-preview")||c.fileInput.click()}),c.fileInput?.addEventListener("change",m=>i(m.target.files)),c.fileImportArea?.addEventListener("dragover",m=>{m.preventDefault(),c.fileImportArea.classList.add("drag-active")}),c.fileImportArea?.addEventListener("dragleave",()=>c.fileImportArea.classList.remove("drag-active")),c.fileImportArea?.addEventListener("drop",m=>{m.preventDefault(),c.fileImportArea.classList.remove("drag-active"),i(m.dataTransfer.files)})}function Mo(){c.sidebarControls&&(c.sidebarControls.innerHTML=`
            <div class="sidebar-control-group"><label class="sidebar-control-label" data-lang-key="level">Level</label><div id="level-switcher-sidebar" class="level-switch"></div></div>
            <div class="sidebar-control-group md:hidden"><label class="sidebar-control-label" data-lang-key="language">Language</label><div id="sidebar-lang-switcher" class="lang-switch">${_n()}</div></div>
            <div class="sidebar-control-group md:hidden"><label class="sidebar-control-label" data-lang-key="theme">Theme</label><div class="theme-switch-wrapper">${xo()}</div></div>
            <button id="sidebar-import-btn" class="w-full mt-4 flex items-center justify-center gap-2 text-sm font-semibold p-3 rounded-lg transition-colors import-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span data-lang-key="importLevel" class="pointer-events-none">Import New Level</span></button>`);let e=document.getElementById("header-lang-switcher");e&&(e.innerHTML=_n()),document.querySelectorAll(".sidebar-control-group .theme-switch input").forEach(t=>t.addEventListener("change",wn)),document.querySelectorAll(".lang-switch button").forEach(t=>t.addEventListener("click",n=>{n.preventDefault(),ce(n.currentTarget.dataset.lang)}))}async function Io(){xt(),await On(),Mo(),ko(),Bn(),c.loadingOverlay&&(c.loadingOverlay.style.opacity="0",c.loadingOverlay.addEventListener("transitionend",()=>c.loadingOverlay.classList.add("hidden"),{once:!0})),ce(d.currentLang,!0),document.querySelectorAll(".lang-switch").forEach(pe);let e=new URLSearchParams(window.location.search),t=e.get("tab")||d.pinnedTab||(window.innerWidth<=768,"external-search");try{let n=await k,a=fetch(`${I.dataPath}/levels.json`).then(h=>h.ok?h.json():{levels:[]}).catch(h=>(console.warn("Could not fetch remote levels list. Falling back to default.",h),{levels:[I.defaultLevel]})),r=n.getAllKeys("levels"),[o,s]=await Promise.all([a,r]),i=o.levels||[I.defaultLevel];d.allAvailableLevels=[...new Set([...i,...s])];let l=e.get("level");l&&d.allAvailableLevels.includes(l)&&(d.currentLevel=l),await Ne(d.currentLevel),he(i,s),document.querySelector(`.level-switch-button[data-level-name="${d.currentLevel}"]`)?.classList.add("active"),jn(),await Be(d.currentLevel),await Co(),W(),ce(d.currentLang,!0),Do(),fe(),await Lt(t,null,!1,!0);let p=document.getElementById("app-version");p&&(p.textContent="v1.0.0");let m={type:"tab",tabName:t,level:d.currentLevel},f=`?level=${d.currentLevel}&tab=${t}`;history.replaceState(m,"",f)}catch(n){console.error("Deferred initialization failed.",n),c.loadingOverlay&&F(S("applicationErrorTitle","Application Error"),S("applicationErrorBody","Something went wrong during startup. Please try refreshing the page.")+`

Error: ${n.message}`)}}document.addEventListener("DOMContentLoaded",Io);export{Rn as closeKanjiDetailModal,gs as openKanjiDetailModal,vs as openNotesModal};
