import{A as K,B as S,C as O,D as F,E as R,a as l,b as A,c as v,d as n,e as D,f as k,g as b,h as g,i as C,j as w,k as x,l as I,m as P,n as M,o as j,p as L,q as y,r as B,s as q,t as z,u as E,v as N,w as V,x as $,y as H,z as m}from"./chunk-YBARZWUW.js";var G;window.addEventListener("beforeinstallprompt",a=>{a.preventDefault(),G=a;let t=document.getElementById("install-app-btn");t&&(t.style.display="flex")});window.addEventListener("appinstalled",()=>{let a=document.getElementById("install-app-btn");a&&(a.style.display="none"),G=null,console.log("PWA was installed")});var U=(a,t={})=>{let e=n.appData.ui?.[n.currentLang]?.[a]||n.appData.ui?.en?.[a]||`[${a}]`;a==="lastSavedOn"&&!n.appData.ui?.[n.currentLang]?.[a]&&(e="Last saved: {date}");for(let[o,s]of Object.entries(t))e=e.replace(`{${o}}`,s);return e};async function J(){let a=["kanji","vocab"],t=[];for(let e of a)n.appData[e]||await(await m).get("levels",n.currentLevel)||t.push(O(n.currentLevel,e));if(t.length>0)try{await Promise.all(t)}catch(e){console.error("Failed to load required data for progress dashboard:",e)}}async function T(a,...t){await P(a,...t),a==="progress"&&L();let e=!["progress","external-search"].includes(a),o=document.querySelectorAll(".notes-header-btn");if(o.forEach(s=>{s.style.display=e?"flex":"none",s.classList.remove("has-note")}),e){let s=await R(n.currentLevel,a),i=s&&typeof s=="object"?!!s.content?.trim():!!s?.trim();o.forEach(r=>{r.classList.toggle("has-note",i)})}}function Q(){return'<label class="theme-switch"><input type="checkbox" aria-label="Theme toggle"><span class="slider"></span></label>'}function W(){return'<div class="lang-switch-pill"></div><button data-lang="en">EN</button><button data-lang="vi">VI</button>'}function X(a){a&&(a.level!==n.currentLevel?w(a.level,!0):T(a.tabName,null,!1,!0))}function Y(){let a=document.documentElement.classList.toggle("dark-mode"),t=a?"dark":"light";l.themeEmoji&&(l.themeEmoji.textContent=a?"\u{1F319}":"\u2600\uFE0F");let e=document.querySelector("#sidebar-controls .theme-switch input");e&&(e.checked=a),S("theme",t);try{localStorage.setItem("theme",t)}catch(o){console.warn("Could not save theme to localStorage.",o)}}function Z(){document.body.addEventListener("click",async t=>{let e=t.target.closest("[data-action]");if(!e)return;let o=e.dataset.action,s={"change-tab":()=>T(e.dataset.tabName,e),"toggle-sidebar":()=>{l.sidebar?.classList.add("open"),l.overlay?.classList.add("active"),document.body.classList.add("sidebar-open")},"toggle-theme":()=>Y(),"toggle-pin":()=>x(),"toggle-sidebar-pin":()=>I(t,e.dataset.tabName),"flip-card":()=>{t.target.closest('[data-action="show-kanji-details"]')||e.closest(".card").classList.toggle("is-flipped")},"toggle-learned":()=>k(e.dataset.category,e.dataset.id,e),"jump-to-section":()=>M(e.dataset.tabName,e.dataset.sectionKey),"delete-level":()=>j(e.dataset.levelName),"set-level":()=>w(e.dataset.levelName),"toggle-accordion":async()=>{e.classList.toggle("open");let i=e.closest(".tab-content")?.id,r=e.dataset.sectionTitleKey;if(i&&r){n.openAccordions.has(i)||n.openAccordions.set(i,new Set);let u=n.openAccordions.get(i);e.classList.contains("open")?u.add(r):u.delete(r);try{let c=await(await m).get("settings","levelSettings")||{};c[n.currentLevel]||(c[n.currentLevel]={}),c[n.currentLevel].openAccordions=Array.from(n.openAccordions.entries()).map(([h,f])=>[h,Array.from(f)]),await S("levelSettings",c)}catch(d){console.error("Error saving accordion state:",d)}}}};s[o]&&(t.preventDefault(),await s[o]()),o==="open-notes"&&(t.preventDefault(),import("./modals-I7FIVCG2.js").then(i=>i.openNotesModal())),o==="show-kanji-details"&&(t.preventDefault(),import("./modals-I7FIVCG2.js").then(i=>i.openKanjiDetailModal(e.dataset.id))),o==="close-kanji-modal"&&(t.preventDefault(),import("./modals-I7FIVCG2.js").then(i=>i.closeKanjiDetailModal()))}),l.overlay?.addEventListener("click",E),l.searchInput?.addEventListener("input",b),l.mobileSearchInput?.addEventListener("input",b),l.closeSidebarBtn?.addEventListener("click",E);let a=D(()=>{document.querySelectorAll(".lang-switch").forEach(y);let t=window.innerWidth<=768;if(l.pinToggle&&(l.pinToggle.style.display=t?"block":"none",t)){let e=document.querySelector(".tab-content.active");e&&q(e.id)}},100);window.addEventListener("resize",a),document.addEventListener("keydown",t=>{t.key==="Escape"&&(l.kanjiDetailModal.classList.contains("modal-hidden")||import("./modals-I7FIVCG2.js").then(e=>e.closeKanjiDetailModal()))}),window.addEventListener("popstate",t=>{X(t.state)})}function _(){l.sidebarControls&&(l.sidebarControls.innerHTML=`
            <div class="sidebar-control-group"><label class="sidebar-control-label" data-lang-key="level">Level</label><div id="level-switcher-sidebar" class="level-switch"></div></div>
            <div class="sidebar-control-group md:hidden"><label class="sidebar-control-label" data-lang-key="language">Language</label><div id="sidebar-lang-switcher" class="lang-switch">${W()}</div></div>
            <div class="sidebar-control-group md:hidden"><label class="sidebar-control-label" data-lang-key="theme">Theme</label><div class="theme-switch-wrapper">${Q()}</div></div>
            <button id="install-app-btn" class="w-full mt-4 flex items-center justify-center gap-2 text-sm font-semibold p-3 rounded-lg transition-colors import-button" style="display: none;">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1h4a1 1 0 001-1V2zm-1 5a1 1 0 011 1v10a1 1 0 11-2 0V8a1 1 0 011-1zm-4-4h2V2H5v2zM15 4h-2V2h2v2zm-2 4h-2v10h2V8z"/></svg>
                <span class="pointer-events-none">Install App</span>
            </button>
            <button id="sidebar-import-btn" class="w-full mt-4 flex items-center justify-center gap-2 text-sm font-semibold p-3 rounded-lg transition-colors import-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span data-lang-key="importLevel" class="pointer-events-none">Import New Level</span></button>`);let a=document.getElementById("header-lang-switcher");a&&(a.innerHTML=W()),document.querySelectorAll(".sidebar-control-group .theme-switch input").forEach(t=>t.addEventListener("change",C)),document.querySelectorAll(".lang-switch button").forEach(t=>t.addEventListener("click",e=>{e.preventDefault(),g(e.currentTarget.dataset.lang)}))}async function ee(){A(),await K(),_(),Z(),B(),document.getElementById("sidebar-import-btn")&&import("./modals-I7FIVCG2.js").then(e=>e.setupImportModal()),l.loadingOverlay&&(l.loadingOverlay.style.opacity="0",l.loadingOverlay.addEventListener("transitionend",()=>l.loadingOverlay.classList.add("hidden"),{once:!0})),g(n.currentLang,!0),document.querySelectorAll(".lang-switch").forEach(y);let a=new URLSearchParams(window.location.search),t=a.get("tab")||n.pinnedTab||(window.innerWidth<=768,"external-search");try{let e=await m,o=fetch(`${v.dataPath}/levels.json`).then(p=>p.ok?p.json():{levels:[]}).catch(p=>(console.warn("Could not fetch remote levels list. Falling back to default.",p),{levels:[v.defaultLevel]})),s=e.getAllKeys("levels"),[i,r]=await Promise.all([o,s]),u=i.levels||[v.defaultLevel];n.allAvailableLevels=[...new Set([...u,...r])];let d=a.get("level");d&&n.allAvailableLevels.includes(d)&&(n.currentLevel=d),await F(n.currentLevel),V(u,r),document.querySelector(`.level-switch-button[data-level-name="${n.currentLevel}"]`)?.classList.add("active"),$(),await N(n.currentLevel),await J(),L(),g(n.currentLang,!0),z(),await T(t,null,!1,!0);let c=document.getElementById("app-version");c&&(c.textContent="v1.0.0");let h={type:"tab",tabName:t,level:n.currentLevel},f=`?level=${n.currentLevel}&tab=${t}`;history.replaceState(h,"",f)}catch(e){console.error("Deferred initialization failed.",e),l.loadingOverlay&&H(U("applicationErrorTitle","Application Error"),U("applicationErrorBody","Something went wrong during startup. Please try refreshing the page.")+`

Error: ${e.message}`)}}document.addEventListener("DOMContentLoaded",ee);
