import{E as H,a as e,c as A,d as m,j as B,u as q,w as $,y as j,z as D}from"./chunk-A5BYHQL4.js";var l=(r,n={})=>{let h=m.appData.ui?.[m.currentLang]?.[r]||m.appData.ui?.en?.[r]||`[${r}]`;r==="lastSavedOn"&&!m.appData.ui?.[m.currentLang]?.[r]&&(h="Last saved: {date}");for(let[o,u]of Object.entries(n))h=h.replace(`{${o}}`,u);return h};function J(r){let n=null;for(let d in m.appData.kanji){let a=m.appData.kanji[d].items.find(S=>S.id===r);if(a){n=a;break}}if(!n){console.error("Kanji item not found:",r);return}let h=document.getElementById("kanji-modal-template");if(!h){console.error("Kanji modal template not found in HTML.");return}let o=h.content.cloneNode(!0);o.querySelector('[data-template-id="kanji-char"]').textContent=n.kanji,o.querySelector('[data-template-id="kanji-meaning"]').textContent=n.meaning?.[m.currentLang]||n.meaning?.en||"";let u=o.querySelector('[data-template-id="examples-section"]');if(n.examples&&n.examples.length>0){let d=o.querySelector('[data-template-id="examples-list"]');u.style.display="block",u.querySelector("[data-lang-key]").textContent=l("modalExamples"),n.examples.forEach(a=>{let S=document.createElement("li");S.className="flex justify-between items-baseline",S.innerHTML=`
                <span class="font-semibold noto-sans with-furigana"><ruby>${a.word}<rt>${a.reading}</rt></ruby></span>
                <span class="kanji-modal-translation">${a.meaning[m.currentLang]||a.meaning.en}</span>`,d.appendChild(S)})}let v=o.querySelector('[data-template-id="sentence-section"]'),C=n.sentence?.jp_tokens,b=n.sentence?.jp;if(C||b){v.style.display="block";let d="";C?d=C.map(a=>a.r?`<ruby>${a.w}<rt>${a.r}</rt></ruby>`:a.w).join(""):d=b,o.querySelector('[data-template-id="sentence-jp"]').innerHTML=d,o.querySelector('[data-template-id="sentence-translation"]').textContent=n.sentence?.[m.currentLang]||n.sentence?.en||""}let T=n.mnemonic?.[m.currentLang]||n.mnemonic?.en||"",k=n.radical?.[m.currentLang]||n.radical?.en||"";if(T||k){let d=o.querySelector('[data-template-id="info-section"]');if(d.style.display="block",d.querySelector("[data-lang-key]").textContent=l("modalInfo"),k){let a=o.querySelector('[data-template-id="radical-section"]');a.style.display="block",a.querySelector("[data-lang-key]").textContent=l("modalRadical"),a.querySelector('[data-template-id="radical-text"]').textContent=k}if(T){let a=o.querySelector('[data-template-id="mnemonic-section"]');a.style.display="block",a.querySelector("[data-lang-key]").textContent=l("modalMnemonic"),a.querySelector('[data-template-id="mnemonic-text"]').textContent=T}}e.kanjiModalContentContainer.innerHTML="",e.kanjiModalContentContainer.appendChild(o);let t=e.kanjiModalContentContainer.querySelector(".kanji-modal-scroll-content"),x=e.kanjiModalContentContainer.querySelector(".fade-indicator");if(t&&x){let d=()=>{let a=t.scrollHeight-t.scrollTop<=t.clientHeight+5;x.style.opacity=a?"0":"1"};t.addEventListener("scroll",d),setTimeout(d,50)}document.body.classList.add("body-no-scroll"),e.kanjiDetailModal.classList.remove("modal-hidden"),e.kanjiModalBackdrop.classList.add("active"),e.kanjiDetailModal.querySelector(".modal-wrapper").classList.add("active")}function Z(){document.body.classList.remove("body-no-scroll"),e.kanjiModalBackdrop.classList.remove("active"),e.kanjiDetailModal.querySelector(".modal-wrapper").classList.remove("active"),setTimeout(()=>{e.kanjiDetailModal.classList.add("modal-hidden")},400)}async function Q(){let r=m.activeTab;if(!r||["progress","external-search"].includes(r))return;let n=document.querySelector(`.nav-item[data-tab-name="${r}"] span`),h=n?n.textContent.trim():r;e.notesModalTitle.textContent=l("notesFor",{tabName:h}),e.notesSaveBtn.textContent=l("saveNotes"),e.notesTextarea.placeholder=l("notesPlaceholder");let o=await H(m.currentLevel,r),u=document.getElementById("note-info-display"),v="";if(o&&typeof o=="object"&&o.lastModified){v=o.content||"";let C=new Date(o.lastModified);if(isNaN(C.getTime()))u.textContent="";else{let b=C.toISOString().split("T")[0];u.textContent=l("lastSavedOn",{date:b})}}else typeof o=="string"?(v=o,u.textContent=""):(v="",u.textContent="");e.notesTextarea.value=v,m.notes.originalContent=v,document.body.classList.add("body-no-scroll"),e.notesModal.classList.remove("modal-hidden"),e.notesModalBackdrop.classList.add("active"),e.notesModalWrapper.classList.add("active"),e.notesTextarea.focus()}function Y(){if(!e.importModal)return;let r={},n=!1,h=()=>{e.importModal.querySelectorAll("[data-lang-key]").forEach(t=>t.textContent=l(t.dataset.langKey)),e.importModal.querySelectorAll("[data-lang-placeholder-key]").forEach(t=>t.placeholder=l(t.dataset.langPlaceholderKey))},o=()=>{document.body.classList.add("body-no-scroll"),q(),C(),h(),e.importModal.classList.remove("modal-hidden"),e.importModalBackdrop.classList.add("active"),e.modalWrapper.classList.add("active")},u=()=>{document.body.classList.remove("body-no-scroll"),e.importModalBackdrop.classList.remove("active"),e.modalWrapper.classList.remove("active"),setTimeout(()=>e.importModal.classList.add("modal-hidden"),300)},v=()=>{let t=e.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");n=!1,t?m.allAvailableLevels.includes(t)?e.levelNameError.textContent=l("errorLevelNameExists"):(e.levelNameError.textContent="",n=!0):e.levelNameError.textContent=l("errorLevelNameRequired");let x=Object.keys(r).length>0;e.importBtn.disabled=!n||!x},C=()=>{e.levelNameInput.value="",e.fileInput.value="",e.levelNameError.textContent="",r={},n=!1,e.fileImportArea.classList.remove("state-preview","drag-active"),e.fileImportArea.innerHTML='<svg class="upload-icon" viewBox="0 0 24 24"><path d="M3 15C3 17.8284 3 19.2426 3.87868 20.1213C4.75736 21 6.17157 21 9 21H15C17.8284 21 19.2426 21 20.1213 20.1213C21 19.2426 21 17.8284 21 15" fill="none" stroke="currentColor"/><path class="arrow" d="M12 16V3M12 3L16 7M12 3L8 7" stroke="currentColor"/></svg><p class="font-semibold text-primary" data-lang-key="dropZoneTitle"></p><p class="text-sm text-secondary" data-lang-key="dropZoneOrClick"></p>',e.fileImportArea.querySelectorAll("[data-lang-key]").forEach(t=>t.textContent=l(t.dataset.langKey)),v()},b=async t=>{let x=t?Array.from(t):[];r={},e.fileInput.value="",e.fileImportArea.classList.add("state-preview");let d=["grammar.csv","hiragana.csv","kanji.csv","katakana.csv","keyPoints.csv","vocab.csv"],a=x.filter(s=>d.includes(s.name));if(a.length===0){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${l("errorNoSupportedFiles")}</p>`,v(),setTimeout(C,2e3);return}let S=s=>{let y=s.replace(/\r/g,"").split(`
`).filter(L=>L.trim()!=="");if(y.length<2)return[];let g=L=>{let p=[],f="",i=!1;for(let c of L)c==='"'&&(f.length===0||!i)?i=!i:c===";"&&!i?(p.push(f),f=""):f+=c;return p.push(f),p.map(c=>c.startsWith('"')&&c.endsWith('"')?c.slice(1,-1):c)},M=g(y[0]).map(L=>L.trim());return y.slice(1).map(L=>{let p=g(L);return p.length!==M.length?(console.warn("Skipping malformed CSV line:",L),null):M.reduce((f,i,c)=>(f[i]=(p[c]||"").trim(),f),{})}).filter(Boolean)},I=(s,y)=>{let g=`user_created_${s}`,M={en:`User ${s.charAt(0).toUpperCase()+s.slice(1)}`,vi:`${s.charAt(0).toUpperCase()+s.slice(1)} ng\u01B0\u1EDDi d\xF9ng`},L=y.map((p,f)=>{let i={id:`${s}_user_${f}`};for(let c in p)if(Object.prototype.hasOwnProperty.call(p,c)){let E=p[c],N=c.match(/_(en|vi)$/);if(N){let w=c.replace(/_(en|vi)$/,""),K=N[1];i[w]||(i[w]={}),i[w][K]=E}else i[c]=E}return s==="kanji"&&(i.examples||(i.examples=[]),i.sentence||(i.sentence={})),i});return{[g]:{...M,items:L}}},P=a.map(s=>new Promise((y,g)=>{let M=new FileReader;M.onload=L=>{try{let p=L.target.result,f=s.name.replace(".csv",""),i=S(p);if(i.length===0){console.warn(`CSV file '${s.name}' is empty or invalid. Skipping.`),y(null);return}let c=I(f,i);y({name:f,data:c})}catch(p){console.error(`Error processing ${s.name}:`,p),g(`Error parsing ${s.name}`)}},M.onerror=()=>g(`Could not read ${s.name}`),M.readAsText(s)}));try{let s=(await Promise.all(P)).filter(Boolean);if(s.length===0){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${l("errorNoValidData")}</p>`,v(),setTimeout(C,2e3);return}s.forEach(g=>{r[g.name]=g.data});let y=`<div class="w-full"><p class="text-sm font-medium mb-2 text-primary">${l("filesToBeImported")}</p><div class="space-y-2">`;a.forEach(g=>{y+=`<div class="preview-item"><p class="font-medium text-primary text-sm">${g.name}</p><span class="text-xs font-mono bg-green-500/20 text-green-300 px-2 py-1 rounded-full">\u2713</span></div>`}),y+="</div></div>",e.fileImportArea.innerHTML=y}catch(s){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${s}</p>`,setTimeout(C,2e3)}v()},T=async()=>{let t=e.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");if(!(!n||Object.keys(r).length===0))try{e.importBtn.disabled=!0,e.importBtn.querySelector("span").textContent=l("importButtonProgress");let x=await D,d={en:{userCreated:"User Created"},vi:{userCreated:"Ng\u01B0\u1EDDi d\xF9ng t\u1EA1o"}};r.ui=d,await x.put("levels",r,t);let a=await fetch(`${A.dataPath}/levels.json`),S=a.ok?await a.json():{levels:[]},I=await x.getAllKeys("levels");$(S.levels,I),await B(t),j(l("successTitle","Success"),l("importSuccess",{levelName:t.toUpperCase()})),u()}catch(x){console.error("Failed to save imported level:",x),j(l("errorTitle","Error"),l("errorSaveImportedLevel","Error: Could not save the new level."))}finally{e.importBtn.disabled=!1,e.importBtn.querySelector("span").textContent=l("importButton")}},k=document.getElementById("sidebar-import-btn");k&&k.addEventListener("click",o),e.closeModalBtn?.addEventListener("click",u),e.modalWrapper?.addEventListener("click",t=>{t.target===e.modalWrapper&&u()}),e.levelNameInput?.addEventListener("input",v),e.importBtn?.addEventListener("click",T),e.fileImportArea?.addEventListener("click",()=>{e.fileImportArea.classList.contains("state-preview")||e.fileInput.click()}),e.fileInput?.addEventListener("change",t=>b(t.target.files)),e.fileImportArea?.addEventListener("dragover",t=>{t.preventDefault(),e.fileImportArea.classList.add("drag-active")}),e.fileImportArea?.addEventListener("dragleave",()=>e.fileImportArea.classList.remove("drag-active")),e.fileImportArea?.addEventListener("drop",t=>{t.preventDefault(),e.fileImportArea.classList.remove("drag-active"),b(t.dataTransfer.files)})}export{Z as closeKanjiDetailModal,J as openKanjiDetailModal,Q as openNotesModal,Y as setupImportModal};
