import{A as K,B as F,G as P,H as O,a as e,c as $,d as l,k as D,v as W,x as H,z as N}from"./chunk-S5DTICEC.js";var s=(o,n={})=>{let p=l.appData.ui?.[l.currentLang]?.[o]||l.appData.ui?.en?.[o]||`[${o}]`;o==="lastSavedOn"&&!l.appData.ui?.[l.currentLang]?.[o]&&(p="Last saved: {date}");for(let[r,v]of Object.entries(n))p=p.replace(`{${r}}`,v);return p},T;function X(o){if(!e.kanjiDetailModal){console.error("Kanji detail modal element not found.");return}let n=null;for(let i in l.appData.kanji){let t=l.appData.kanji[i].items.find(d=>d.id===o);if(t){n=t;break}}if(!n){console.error("Kanji item not found:",o);return}let p=document.getElementById("kanji-modal-template");if(!p){console.error("Kanji modal template not found in HTML.");return}let r=p.content.cloneNode(!0);r.querySelector('[data-template-id="kanji-char"]').textContent=n.kanji,r.querySelector('[data-template-id="kanji-meaning"]').textContent=n.meaning?.[l.currentLang]||n.meaning?.en||"";let v=r.querySelector('[data-template-id="examples-section"]');if(n.examples&&n.examples.length>0){let i=r.querySelector('[data-template-id="examples-list"]');v.style.display="block",v.querySelector("[data-lang-key]").textContent=s("modalExamples"),n.examples.forEach(t=>{let d=document.createElement("li");d.className="flex justify-between items-baseline",d.innerHTML=`
                <span class="font-semibold noto-sans with-furigana"><ruby>${t.word}<rt>${t.reading}</rt></ruby></span>
                <span class="kanji-modal-translation">${t.meaning[l.currentLang]||t.meaning.en}</span>`,i.appendChild(d)})}let f=r.querySelector('[data-template-id="sentence-section"]'),y=n.sentence?.jp_tokens,x=n.sentence?.jp;if(y||x){f.style.display="block";let i="";y?i=y.map(t=>t.r?`<ruby>${t.w}<rt>${t.r}</rt></ruby>`:t.w).join(""):i=x,r.querySelector('[data-template-id="sentence-jp"]').innerHTML=i,r.querySelector('[data-template-id="sentence-translation"]').textContent=n.sentence?.[l.currentLang]||n.sentence?.en||""}let S=n.mnemonic?.[l.currentLang]||n.mnemonic?.en||"",C=n.radical?.[l.currentLang]||n.radical?.en||"";if(S||C){let i=r.querySelector('[data-template-id="info-section"]');if(i.style.display="block",i.querySelector("[data-lang-key]").textContent=s("modalInfo"),C){let t=r.querySelector('[data-template-id="radical-section"]');t.style.display="block",t.querySelector("[data-lang-key]").textContent=s("modalRadical"),t.querySelector('[data-template-id="radical-text"]').textContent=C}if(S){let t=r.querySelector('[data-template-id="mnemonic-section"]');t.style.display="block",t.querySelector("[data-lang-key]").textContent=s("modalMnemonic"),t.querySelector('[data-template-id="mnemonic-text"]').textContent=S}}e.kanjiModalContentContainer.innerHTML="",e.kanjiModalContentContainer.appendChild(r);let a=e.kanjiModalContentContainer.querySelector(".kanji-modal-scroll-content"),L=e.kanjiModalContentContainer.querySelector(".fade-indicator");if(a&&L){let i=()=>{let t=a.scrollHeight-a.scrollTop<=a.clientHeight+5;L.style.opacity=t?"0":"1"};a.addEventListener("scroll",i),setTimeout(i,50)}let E=()=>V(),M=i=>{i.target===e.kanjiModalWrapper&&E()},w=i=>{i.key==="Escape"&&E()},b=e.kanjiModalContentContainer.querySelector('[data-action="close-kanji-modal"]');b&&b.addEventListener("click",E),e.kanjiModalWrapper.addEventListener("click",M),document.addEventListener("keydown",w),T=()=>{e.kanjiModalWrapper.removeEventListener("click",M),document.removeEventListener("keydown",w),b&&b.removeEventListener("click",E),T=null},document.body.classList.add("body-no-scroll"),e.kanjiDetailModal.classList.remove("modal-hidden"),requestAnimationFrame(()=>{e.kanjiDetailModal.classList.add("active"),e.kanjiModalBackdrop.classList.add("active"),e.kanjiModalWrapper&&e.kanjiModalWrapper.classList.add("active")})}function V(){T&&T(),e.kanjiDetailModal.classList.remove("active"),e.kanjiModalBackdrop.classList.remove("active"),e.kanjiModalWrapper&&e.kanjiModalWrapper.classList.remove("active"),document.body.classList.remove("body-no-scroll"),e.kanjiModalWrapper.addEventListener("transitionend",()=>{e.kanjiDetailModal.classList.add("modal-hidden")},{once:!0})}var I;async function ee(){let o=l.activeTab;if(!o||["progress","external-search"].includes(o))return;let n=document.querySelector(`.nav-item[data-tab-name="${o}"] span`),p=n?n.textContent.trim():o;e.notesModalTitle.textContent=s("notesFor",{tabName:p}),e.notesSaveBtn.textContent=s("saveNotes"),e.notesTextarea.placeholder=s("notesPlaceholder");let r=await O(l.currentLevel,o),v=document.getElementById("note-info-display"),f="";if(r&&typeof r=="object"&&r.lastModified){f=r.content||"";let a=new Date(r.lastModified);if(isNaN(a.getTime()))v.textContent="";else{let L=a.toISOString().split("T")[0];v.textContent=s("lastSavedOn",{date:L})}}else typeof r=="string"?(f=r,v.textContent=""):(f="",v.textContent="");e.notesTextarea.value=f,l.notes.originalContent=f;let y=()=>U(),x=()=>R(),S=a=>{a.target===e.notesModalWrapper&&y()},C=a=>{a.key==="Escape"&&y()};e.closeNotesModalBtn.addEventListener("click",y),e.notesSaveBtn.addEventListener("click",x),e.notesModalWrapper.addEventListener("click",S),document.addEventListener("keydown",C),I=()=>{e.closeNotesModalBtn.removeEventListener("click",y),e.notesSaveBtn.removeEventListener("click",x),e.notesModalWrapper.removeEventListener("click",S),document.removeEventListener("keydown",C),I=null},document.body.classList.add("body-no-scroll"),e.notesModal.classList.remove("modal-hidden"),requestAnimationFrame(()=>{e.notesModalBackdrop.classList.add("active"),e.notesModalWrapper.classList.add("active"),e.notesTextarea.focus()})}function U(){let o=e.notesTextarea.value,n=l.notes.originalContent,p=()=>{I&&I(),document.body.classList.remove("body-no-scroll"),e.notesModalBackdrop.classList.remove("active"),e.notesModalWrapper.classList.remove("active"),e.notesModalWrapper.addEventListener("transitionend",()=>{e.notesModal.classList.add("modal-hidden")},{once:!0}),l.notes.originalContent=""};o!==n?K(s("unsavedChangesTitle","Unsaved Changes"),s("unsavedChangesBody","You have unsaved changes. Are you sure you want to close without saving?")).then(r=>{r&&p()}):p()}async function R(){let o=e.notesTextarea.value;await P(l.currentLevel,l.activeTab,o),l.notes.originalContent=o,document.querySelectorAll(".notes-header-btn").forEach(p=>{p.classList.toggle("has-note",!!o.trim())}),e.notesStatus.textContent=s("savedStatus","Saved!"),e.notesStatus.style.opacity="1",setTimeout(()=>{U(),setTimeout(()=>{e.notesStatus.style.opacity="0"},500)},1e3)}function te(){if(!e.importModal)return;let o={},n=!1,p=()=>{e.importModal.querySelectorAll("[data-lang-key]").forEach(a=>a.textContent=s(a.dataset.langKey)),e.importModal.querySelectorAll("[data-lang-placeholder-key]").forEach(a=>a.placeholder=s(a.dataset.langPlaceholderKey))},r=()=>{document.body.classList.add("body-no-scroll"),W(),y(),p(),e.importModal.classList.remove("modal-hidden"),requestAnimationFrame(()=>{e.importModalBackdrop.classList.add("active"),e.modalWrapper.classList.add("active")})},v=()=>{document.body.classList.remove("body-no-scroll"),e.importModalBackdrop.classList.remove("active"),e.modalWrapper.classList.remove("active"),e.modalWrapper.addEventListener("transitionend",()=>{e.importModal.classList.add("modal-hidden")},{once:!0})},f=()=>{let a=e.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");n=!1,a?l.allAvailableLevels.includes(a)?e.levelNameError.textContent=s("errorLevelNameExists"):(e.levelNameError.textContent="",n=!0):e.levelNameError.textContent=s("errorLevelNameRequired");let L=Object.keys(o).length>0;e.importBtn.disabled=!n||!L},y=()=>{e.levelNameInput.value="",e.fileInput.value="",e.levelNameError.textContent="",o={},n=!1,e.fileImportArea.classList.remove("state-preview","drag-active"),e.fileImportArea.innerHTML='<svg class="upload-icon" viewBox="0 0 24 24"><path d="M3 15C3 17.8284 3 19.2426 3.87868 20.1213C4.75736 21 6.17157 21 9 21H15C17.8284 21 19.2426 21 20.1213 20.1213C21 19.2426 21 17.8284 21 15" fill="none" stroke="currentColor"/><path class="arrow" d="M12 16V3M12 3L16 7M12 3L8 7" stroke="currentColor"/></svg><p class="font-semibold text-primary" data-lang-key="dropZoneTitle"></p><p class="text-sm text-secondary" data-lang-key="dropZoneOrClick"></p>',e.fileImportArea.querySelectorAll("[data-lang-key]").forEach(a=>a.textContent=s(a.dataset.langKey)),f()},x=async a=>{let L=a?Array.from(a):[];o={},e.fileInput.value="",e.fileImportArea.classList.add("state-preview");let E=["grammar.csv","hiragana.csv","kanji.csv","katakana.csv","keyPoints.csv","vocab.csv"],M=L.filter(t=>E.includes(t.name));if(M.length===0){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${s("errorNoSupportedFiles")}</p>`,f(),setTimeout(y,2e3);return}let w=t=>{let d=t.replace(/\r/g,"").split(`
`).filter(k=>k.trim()!=="");if(d.length<2)return[];let h=k=>{let u=[],g="",c=!1;for(let m of k)m==='"'&&(g.length===0||!c)?c=!c:m===";"&&!c?(u.push(g),g=""):g+=m;return u.push(g),u.map(m=>m.startsWith('"')&&m.endsWith('"')?m.slice(1,-1):m)},j=h(d[0]).map(k=>k.trim());return d.slice(1).map(k=>{let u=h(k);return u.length!==j.length?(console.warn("Skipping malformed CSV line:",k),null):j.reduce((g,c,m)=>(g[c]=(u[m]||"").trim(),g),{})}).filter(Boolean)},b=(t,d)=>{let h=`user_created_${t}`,j={en:`User ${t.charAt(0).toUpperCase()+t.slice(1)}`,vi:`${t.charAt(0).toUpperCase()+t.slice(1)} ng\u01B0\u1EDDi d\xF9ng`},k=d.map((u,g)=>{let c={id:`${t}_user_${g}`};for(let m in u)if(Object.prototype.hasOwnProperty.call(u,m)){let A=u[m],q=m.match(/_(en|vi)$/);if(q){let B=m.replace(/_(en|vi)$/,""),_=q[1];c[B]||(c[B]={}),c[B][_]=A}else c[m]=A}return t==="kanji"&&(c.examples||(c.examples=[]),c.sentence||(c.sentence={})),c});return{[h]:{...j,items:k}}},i=M.map(t=>new Promise((d,h)=>{let j=new FileReader;j.onload=k=>{try{let u=k.target.result,g=t.name.replace(".csv",""),c=w(u);if(c.length===0){console.warn(`CSV file '${t.name}' is empty or invalid. Skipping.`),d(null);return}let m=b(g,c);d({name:g,data:m})}catch(u){console.error(`Error processing ${t.name}:`,u),h(`Error parsing ${t.name}`)}},j.onerror=()=>h(`Could not read ${t.name}`),j.readAsText(t)}));try{let t=(await Promise.all(i)).filter(Boolean);if(t.length===0){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${s("errorNoValidData")}</p>`,f(),setTimeout(y,2e3);return}t.forEach(h=>{o[h.name]=h.data});let d=`<div class="w-full"><p class="text-sm font-medium mb-2 text-primary">${s("filesToBeImported")}</p><div class="space-y-2">`;M.forEach(h=>{d+=`<div class="preview-item"><p class="font-medium text-primary text-sm">${h.name}</p><span class="text-xs font-mono bg-green-500/20 text-green-300 px-2 py-1 rounded-full">\u2713</span></div>`}),d+="</div></div>",e.fileImportArea.innerHTML=d}catch(t){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${t}</p>`,setTimeout(y,2e3)}f()},S=async()=>{let a=e.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");if(!(!n||Object.keys(o).length===0))try{e.importBtn.disabled=!0,e.importBtn.querySelector("span").textContent=s("importButtonProgress");let L=await F,E={en:{userCreated:"User Created"},vi:{userCreated:"Ng\u01B0\u1EDDi d\xF9ng t\u1EA1o"}};o.ui=E,await L.put("levels",o,a);let M=await fetch(`${$.dataPath}/levels.json`),w=M.ok?await M.json():{levels:[]},b=await L.getAllKeys("levels");H(w.levels,b),await D(a),N(s("successTitle","Success"),s("importSuccess",{levelName:a.toUpperCase()})),v()}catch(L){console.error("Failed to save imported level:",L),N(s("errorTitle","Error"),s("errorSaveImportedLevel","Error: Could not save the new level."))}finally{e.importBtn.disabled=!1,e.importBtn.querySelector("span").textContent=s("importButton")}},C=document.getElementById("sidebar-import-btn");C&&C.addEventListener("click",r),e.closeModalBtn?.addEventListener("click",v),e.modalWrapper?.addEventListener("click",a=>{a.target===e.modalWrapper&&v()}),e.levelNameInput?.addEventListener("input",f),e.importBtn?.addEventListener("click",S),e.fileImportArea?.addEventListener("click",()=>{e.fileImportArea.classList.contains("state-preview")||e.fileInput.click()}),e.fileInput?.addEventListener("change",a=>x(a.target.files)),e.fileImportArea?.addEventListener("dragover",a=>{a.preventDefault(),e.fileImportArea.classList.add("drag-active")}),e.fileImportArea?.addEventListener("dragleave",()=>e.fileImportArea.classList.remove("drag-active")),e.fileImportArea?.addEventListener("drop",a=>{a.preventDefault(),e.fileImportArea.classList.remove("drag-active"),x(a.dataTransfer.files)})}export{V as closeKanjiDetailModal,X as openKanjiDetailModal,ee as openNotesModal,te as setupImportModal};
