import{A as K,B as F,G as P,H as O,a as e,c as W,d as m,f as o,l as $,v as D,x as H,z as N}from"./chunk-VZUEGDHL.js";var T;function ee(s){if(!e.kanjiDetailModal){console.error("Kanji detail modal element not found.");return}let n=null;for(let l in m.appData.kanji){let t=m.appData.kanji[l].items.find(c=>c.id===s);if(t){n=t;break}}if(!n){console.error("Kanji item not found:",s);return}let k=document.getElementById("kanji-modal-template");if(!k){console.error("Kanji modal template not found in HTML.");return}let r=k.content.cloneNode(!0);r.querySelector('[data-template-id="kanji-char"]').textContent=n.kanji,r.querySelector('[data-template-id="kanji-meaning"]').textContent=n.meaning?.[m.currentLang]||n.meaning?.en||"";let h=r.querySelector('[data-template-id="examples-section"]');if(n.examples&&n.examples.length>0){let l=r.querySelector('[data-template-id="examples-list"]');h.style.display="block",h.querySelector("[data-lang-key]").textContent=o("modalExamples"),n.examples.forEach(t=>{let c=document.createElement("li");c.className="flex justify-between items-baseline",c.innerHTML=`
                <span class="font-semibold noto-sans with-furigana"><ruby>${t.word}<rt>${t.reading}</rt></ruby></span>
                <span class="kanji-modal-translation">${t.meaning[m.currentLang]||t.meaning.en}</span>`,l.appendChild(c)})}let u=r.querySelector('[data-template-id="sentence-section"]'),v=n.sentence?.jp_tokens,x=n.sentence?.jp;if(v||x){u.style.display="block";let l="";v?l=v.map(t=>t.r?`<ruby>${t.w}<rt>${t.r}</rt></ruby>`:t.w).join(""):l=x,r.querySelector('[data-template-id="sentence-jp"]').innerHTML=l,r.querySelector('[data-template-id="sentence-translation"]').textContent=n.sentence?.[m.currentLang]||n.sentence?.en||""}let S=n.mnemonic?.[m.currentLang]||n.mnemonic?.en||"",C=n.radical?.[m.currentLang]||n.radical?.en||"";if(S||C){let l=r.querySelector('[data-template-id="info-section"]');if(l.style.display="block",l.querySelector("[data-lang-key]").textContent=o("modalInfo"),C){let t=r.querySelector('[data-template-id="radical-section"]');t.style.display="block",t.querySelector("[data-lang-key]").textContent=o("modalRadical"),t.querySelector('[data-template-id="radical-text"]').textContent=C}if(S){let t=r.querySelector('[data-template-id="mnemonic-section"]');t.style.display="block",t.querySelector("[data-lang-key]").textContent=o("modalMnemonic"),t.querySelector('[data-template-id="mnemonic-text"]').textContent=S}}e.kanjiModalContentContainer.innerHTML="",e.kanjiModalContentContainer.appendChild(r);let a=e.kanjiModalContentContainer.querySelector(".kanji-modal-scroll-content"),f=e.kanjiModalContentContainer.querySelector(".fade-indicator");if(a&&f){let l=()=>{let t=a.scrollHeight-a.scrollTop<=a.clientHeight+5;f.style.opacity=t?"0":"1"};a.addEventListener("scroll",l),setTimeout(l,50)}let E=()=>V(),M=l=>{l.target===e.kanjiModalWrapper&&E()},w=l=>{l.key==="Escape"&&E()},b=e.kanjiModalContentContainer.querySelector('[data-action="close-kanji-modal"]');b&&b.addEventListener("click",E),e.kanjiModalWrapper.addEventListener("click",M),document.addEventListener("keydown",w),T=()=>{e.kanjiModalWrapper.removeEventListener("click",M),document.removeEventListener("keydown",w),b&&b.removeEventListener("click",E),T=null},document.body.classList.add("body-no-scroll"),e.kanjiDetailModal.classList.remove("modal-hidden"),requestAnimationFrame(()=>{e.kanjiDetailModal.classList.add("active"),e.kanjiModalBackdrop.classList.add("active"),e.kanjiModalWrapper&&e.kanjiModalWrapper.classList.add("active")})}function V(){T&&T(),e.kanjiDetailModal.classList.remove("active"),e.kanjiModalBackdrop.classList.remove("active"),e.kanjiModalWrapper&&e.kanjiModalWrapper.classList.remove("active"),document.body.classList.remove("body-no-scroll"),e.kanjiModalWrapper.addEventListener("transitionend",()=>{e.kanjiDetailModal.classList.add("modal-hidden")},{once:!0})}var I;async function te(){let s=m.activeTab;if(!s||["progress","external-search"].includes(s))return;let n=document.querySelector(`.nav-item[data-tab-name="${s}"] span`),k=n?n.textContent.trim():s;e.notesModalTitle.textContent=o("notesFor",{tabName:k}),e.notesSaveBtn.textContent=o("saveNotes"),e.notesTextarea.placeholder=o("notesPlaceholder");let r=await O(m.currentLevel,s),h=document.getElementById("note-info-display"),u="";if(r&&typeof r=="object"&&r.lastModified){u=r.content||"";let a=new Date(r.lastModified);if(isNaN(a.getTime()))h.textContent="";else{let f=a.toISOString().split("T")[0];h.textContent=o("lastSavedOn",{date:f})}}else typeof r=="string"?(u=r,h.textContent=""):(u="",h.textContent="");e.notesTextarea.value=u,m.notes.originalContent=u;let v=()=>U(),x=()=>R(),S=a=>{a.target===e.notesModalWrapper&&v()},C=a=>{a.key==="Escape"&&v()};e.closeNotesModalBtn.addEventListener("click",v),e.notesSaveBtn.addEventListener("click",x),e.notesModalWrapper.addEventListener("click",S),document.addEventListener("keydown",C),I=()=>{e.closeNotesModalBtn.removeEventListener("click",v),e.notesSaveBtn.removeEventListener("click",x),e.notesModalWrapper.removeEventListener("click",S),document.removeEventListener("keydown",C),I=null},document.body.classList.add("body-no-scroll"),e.notesModal.classList.remove("modal-hidden"),requestAnimationFrame(()=>{e.notesModalBackdrop.classList.add("active"),e.notesModalWrapper.classList.add("active"),e.notesTextarea.focus()})}function U(){let s=e.notesTextarea.value,n=m.notes.originalContent,k=()=>{I&&I(),document.body.classList.remove("body-no-scroll"),e.notesModalBackdrop.classList.remove("active"),e.notesModalWrapper.classList.remove("active"),e.notesModalWrapper.addEventListener("transitionend",()=>{e.notesModal.classList.add("modal-hidden")},{once:!0}),m.notes.originalContent=""};s!==n?K(o("unsavedChangesTitle","Unsaved Changes"),o("unsavedChangesBody","You have unsaved changes. Are you sure you want to close without saving?")).then(r=>{r&&k()}):k()}async function R(){let s=e.notesTextarea.value;await P(m.currentLevel,m.activeTab,s),m.notes.originalContent=s,document.querySelectorAll(".notes-header-btn").forEach(k=>{k.classList.toggle("has-note",!!s.trim())}),e.notesStatus.textContent=o("savedStatus","Saved!"),e.notesStatus.style.opacity="1",setTimeout(()=>{U(),setTimeout(()=>{e.notesStatus.style.opacity="0"},500)},1e3)}function ae(){if(!e.importModal)return;let s={},n=!1,k=()=>{e.importModal.querySelectorAll("[data-lang-key]").forEach(a=>a.textContent=o(a.dataset.langKey)),e.importModal.querySelectorAll("[data-lang-placeholder-key]").forEach(a=>a.placeholder=o(a.dataset.langPlaceholderKey))},r=()=>{document.body.classList.add("body-no-scroll"),D(),v(),k(),e.importModal.classList.remove("modal-hidden"),requestAnimationFrame(()=>{e.importModalBackdrop.classList.add("active"),e.modalWrapper.classList.add("active")})},h=()=>{document.body.classList.remove("body-no-scroll"),e.importModalBackdrop.classList.remove("active"),e.modalWrapper.classList.remove("active"),e.modalWrapper.addEventListener("transitionend",()=>{e.importModal.classList.add("modal-hidden")},{once:!0})},u=()=>{let a=e.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");n=!1,a?m.allAvailableLevels.includes(a)?e.levelNameError.textContent=o("errorLevelNameExists"):(e.levelNameError.textContent="",n=!0):e.levelNameError.textContent=o("errorLevelNameRequired");let f=Object.keys(s).length>0;e.importBtn.disabled=!n||!f},v=()=>{e.levelNameInput.value="",e.fileInput.value="",e.levelNameError.textContent="",s={},n=!1,e.fileImportArea.classList.remove("state-preview","drag-active"),e.fileImportArea.innerHTML='<svg class="upload-icon" viewBox="0 0 24 24"><path d="M3 15C3 17.8284 3 19.2426 3.87868 20.1213C4.75736 21 6.17157 21 9 21H15C17.8284 21 19.2426 21 20.1213 20.1213C21 19.2426 21 17.8284 21 15" fill="none" stroke="currentColor"/><path class="arrow" d="M12 16V3M12 3L16 7M12 3L8 7" stroke="currentColor"/></svg><p class="font-semibold text-primary" data-lang-key="dropZoneTitle"></p><p class="text-sm text-secondary" data-lang-key="dropZoneOrClick"></p>',e.fileImportArea.querySelectorAll("[data-lang-key]").forEach(a=>a.textContent=o(a.dataset.langKey)),u()},x=async a=>{let f=a?Array.from(a):[];s={},e.fileInput.value="",e.fileImportArea.classList.add("state-preview");let E=["grammar.csv","hiragana.csv","kanji.csv","katakana.csv","keyPoints.csv","vocab.csv"],M=f.filter(t=>E.includes(t.name));if(M.length===0){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${o("errorNoSupportedFiles")}</p>`,u(),setTimeout(v,2e3);return}let w=t=>{let c=t.replace(/\r/g,"").split(`
`).filter(g=>g.trim()!=="");if(c.length<2)return[];let L=g=>{let p=[],y="",i=!1;for(let d of g)d==='"'&&(y.length===0||!i)?i=!i:d===";"&&!i?(p.push(y),y=""):y+=d;return p.push(y),p.map(d=>d.startsWith('"')&&d.endsWith('"')?d.slice(1,-1):d)},j=L(c[0]).map(g=>g.trim());return c.slice(1).map(g=>{let p=L(g);return p.length!==j.length?(console.warn("Skipping malformed CSV line:",g),null):j.reduce((y,i,d)=>(y[i]=(p[d]||"").trim(),y),{})}).filter(Boolean)},b=(t,c)=>{let L=`user_created_${t}`,j={en:`User ${t.charAt(0).toUpperCase()+t.slice(1)}`,vi:`${t.charAt(0).toUpperCase()+t.slice(1)} ng\u01B0\u1EDDi d\xF9ng`},g=c.map((p,y)=>{let i={id:`${t}_user_${y}`};for(let d in p)if(Object.prototype.hasOwnProperty.call(p,d)){let A=p[d],q=d.match(/_(en|vi)$/);if(q){let B=d.replace(/_(en|vi)$/,""),_=q[1];i[B]||(i[B]={}),i[B][_]=A}else i[d]=A}return t==="kanji"&&(i.examples||(i.examples=[]),i.sentence||(i.sentence={})),i});return{[L]:{...j,items:g}}},l=M.map(t=>new Promise((c,L)=>{let j=new FileReader;j.onload=g=>{try{let p=g.target.result,y=t.name.replace(".csv",""),i=w(p);if(i.length===0){console.warn(`CSV file '${t.name}' is empty or invalid. Skipping.`),c(null);return}let d=b(y,i);c({name:y,data:d})}catch(p){console.error(`Error processing ${t.name}:`,p),L(`Error parsing ${t.name}`)}},j.onerror=()=>L(`Could not read ${t.name}`),j.readAsText(t)}));try{let t=(await Promise.all(l)).filter(Boolean);if(t.length===0){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${o("errorNoValidData")}</p>`,u(),setTimeout(v,2e3);return}t.forEach(L=>{s[L.name]=L.data});let c=`<div class="w-full"><p class="text-sm font-medium mb-2 text-primary">${o("filesToBeImported")}</p><div class="space-y-2">`;M.forEach(L=>{c+=`<div class="preview-item"><p class="font-medium text-primary text-sm">${L.name}</p><span class="text-xs font-mono bg-green-500/20 text-green-300 px-2 py-1 rounded-full">\u2713</span></div>`}),c+="</div></div>",e.fileImportArea.innerHTML=c}catch(t){e.fileImportArea.innerHTML=`<p class="text-red-400 text-sm">${t}</p>`,setTimeout(v,2e3)}u()},S=async()=>{let a=e.levelNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,"");if(!(!n||Object.keys(s).length===0))try{e.importBtn.disabled=!0,e.importBtn.querySelector("span").textContent=o("importButtonProgress");let f=await F,E={en:{userCreated:"User Created"},vi:{userCreated:"Ng\u01B0\u1EDDi d\xF9ng t\u1EA1o"}};s.ui=E,await f.put("levels",s,a);let M=await fetch(`${W.dataPath}/levels.json`),w=M.ok?await M.json():{levels:[]},b=await f.getAllKeys("levels");H(w.levels,b),await $(a),N(o("successTitle","Success"),o("importSuccess",{levelName:a.toUpperCase()})),h()}catch(f){console.error("Failed to save imported level:",f),N(o("errorTitle","Error"),o("errorSaveImportedLevel","Error: Could not save the new level."))}finally{e.importBtn.disabled=!1,e.importBtn.querySelector("span").textContent=o("importButton")}},C=document.getElementById("sidebar-import-btn");C&&C.addEventListener("click",r),e.closeModalBtn?.addEventListener("click",h),e.modalWrapper?.addEventListener("click",a=>{a.target===e.modalWrapper&&h()}),e.levelNameInput?.addEventListener("input",u),e.importBtn?.addEventListener("click",S),e.fileImportArea?.addEventListener("click",()=>{e.fileImportArea.classList.contains("state-preview")||e.fileInput.click()}),e.fileInput?.addEventListener("change",a=>x(a.target.files)),e.fileImportArea?.addEventListener("dragover",a=>{a.preventDefault(),e.fileImportArea.classList.add("drag-active")}),e.fileImportArea?.addEventListener("dragleave",()=>e.fileImportArea.classList.remove("drag-active")),e.fileImportArea?.addEventListener("drop",a=>{a.preventDefault(),e.fileImportArea.classList.remove("drag-active"),x(a.dataTransfer.files)})}export{V as closeKanjiDetailModal,ee as openKanjiDetailModal,te as openNotesModal,ae as setupImportModal};
